bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.activity",{},{init:function(e,t,i){var s=this;s.params=i||{},s._super(e,t,i),s.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity").concat("#project-dashboard-menu1")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var i=this;i.params=$.extend(i.params,t.args),i.params.plan.idActivitySelected=void 0,i.clean();var s=i.getContent().empty();void 0!==e.type&&(i.params.showContextByMenuDashboard=e.type);var a={showFormOverview:i.params.menuDashboard.showFormOverview,showFormActivity:i.params.menuDashboard.showFormActivity,showCommentsOptionMenu:i.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:i.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:i.params.menuDashboard.showTimeLineOptionMenu&&(!i.params.isAdhocProcess||i.params.isAdhocProcess&&bizagi.util.isEnableFeature("enableTimelineOnLiveProcesses")),showPlanOptionMenu:i.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:i.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:i.params.menuDashboard.contextFormActivityOptionMenu};i.getTemplate("project-dashboard-menu").render(a).appendTo(s),i.params.showContextByMenuDashboard&&$("li[data-context='"+i.params.showContextByMenuDashboard.toUpperCase()+"']",i.content).addClass("active").siblings().removeClass("active"),i.handlerEvents()},loadContentById:function(e){var t=this;e.preventDefault();var i=$(e.target).closest("li");if(!i.hasClass("active")){var s=i.data("context");s&&$.when(bizagi.util.autoSave()).done(function(){$(document).data("auto-save","");var e=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),i=parseInt(e[0],10),a="",o=i;"PLANACTIVITIES"==s&&(o=i+1,a=bizagi.localization.getResource("workportal-project-casedashboard-plan")),t.params.refreshLastItemBreadcrumb=!1,t.pub("notify",{type:s.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:s,histName:a,level:o})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")})}},subMenuHandler:function(){var e=this.getContent(),t=$("[data-context='COMMENTS']",e),i=$("[data-context='FILES']",e),s=$("[data-context='TIMELINE']",e);$(".ui-bizagi-wp-project-tab-submenu a",e).on("click",function(){t.toggle(),i.toggle(),s.toggle()})},handlerEvents:function(){var e=this,t=e.getContent();e.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(e.loadContentById,e)),$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",t).on("click",function(){var t={action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:e.params.idCase,idTask:e.params.idTask,idWorkflow:e.params.idWorkflow,idWorkItem:e.params.idWorkitem,referrer:e.params.referrer||"inboxGrid"};e.publish("executeAction",t)})},clean:function(){var e=this,t=e.getContent();e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))}),$(".ui-bizagi-wp-project-tab-links a",t).off(),$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",t).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(e,t,i){this._super(e,t,i),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var e=this,t=e.getTemplate("project-content-dashboard");return e.content=t.render({}),e.content},postRender:function(){setTimeout(function(){$(window).trigger("resize")},1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),function(e){var t=window.kendo.ui,i=t.Widget,s=i.extend({init:function(e,t){var s=this;i.fn.init.call(s,e,t),s._maxFilesSize=t.maxSize,s._fileList=[],s._onlyValidateServerFileExtension=t.onlyValidateServerFileExtension||!0,s._supportFileExt=t.extensions,s._uploadMaxFilesSize=t.maxSize,s.upload=s._initUpload(),s.loadNotifier=s._initLoadNotifier(),s.notification=s._initNotification(),s._eventsHandler(),s._initLocalization(s.options.localization)},options:{name:"ProjectAttachments",wrapper:e('<div class="project-attachments"></div>'),multiple:!0,dropZone:!0,maxFilesSize:bizagi.currentUser?bizagi.currentUser.uploadMaxFileSize:25e3,enabled:!0,localization:{}},_initUpload:function(){var e=this,t=e.options,i=t.localization||{},s=0;return e._initLocalization(i),this.element.kendoUpload({async:{saveUrl:t.saveUrl+"?xsrf="+bizagi.getXSRFToken(),autoUpload:!0},select:function(t){e._filterMaxFilesSize(t),s=0},complete:function(){var t=setInterval(function(){0===e.loadNotifier.wrapper.find("li.k-file-progress").length&&(e._showNotificationCompleteUpload(e.loadNotifier.wrapper,s),clearInterval(t))},300)},upload:t.upload,progress:function(t){e._onProgressFile(t)},success:function(i){e._fileList.push(i.files[0]),s+=1,t.success(i)},error:function(t){e.onErrorFile(t)},localization:{select:i.selectFiles,dropFilesHere:i.dropFilesHere},multiple:t.multiple,enabled:t.enabled,dropZone:t.dropZone,showFileList:!1}).data("kendoUpload")},_initNotification:function(){return e("<div></div>").kendoNotification({position:{pinned:!0}}).data("kendoNotification")},_initLoadNotifier:function(){var e=this.options.localization;return this.options.wrapper.kendoWindow({title:e.notifierTitle,actions:["Close"],animation:{open:{duration:100},close:{duration:100}},open:function(){this.wrapper.addClass("project-attachments-wrapper-window")},visible:!1,resizable:!1,draggable:!1,maxHeight:"300px",minWidth:"430px"}).data("kendoWindow")},_initLocalization:function(t){var i={selectFiles:bizagi.localization.getResource("workportal-project-attachments-addfiles"),notifierTitle:bizagi.localization.getResource("workportal-project-attachments-notifiertitle"),errorUpload:bizagi.localization.getResource("workportal-project-attachments-file-error-type"),errorSecurity:bizagi.localization.getResource("workportal-project-attachments-blockedext"),errorSize:bizagi.localization.getResource("workportal-project-attachments-blockedsize"),errorMaxFilesSize:bizagi.localization.getResource("workportal-project-discussion-maxfilessize").replace("%s",Math.round(this._maxFilesSize/1e6,-1)),dropFilesHere:bizagi.localization.getResource("workportal-project-attachments-drophere"),cancel:bizagi.localization.getResource("workportal-widget-reports-confirm-cancel"),retry:bizagi.localization.getResource("workportal-project-attachments-retry"),close:bizagi.localization.getResource("workportal-widget-dialog-box-close")};e.extend(t,i)},_onProgressFile:function(t){var i=this._getFileItemByUID(t.files[0].uid),s=t.percentComplete;e(".k-progress",i).css({width:s+"%"}),e(".k-upload-pct",i).removeClass("k-icon k-loading").text(s+"%"),100===s&&e(".k-upload-action .k-icon",i).hide()},_onShowUploadNotifier:function(e){var t=e.files,i=this.options.template;this.loadNotifier.content(i.render({files:t})),this.loadNotifier.wrapper.css({top:"auto",left:"auto",bottom:"1em",right:"1em"}),this.loadNotifier.open()},_showNotificationCompleteUpload:function(e,t){e.find("li.k-file-success").length===t&&0===e.find("li.k-file-error").length&&this._autoHideMessage(e)},_autoHideMessage:function(e){var t=this;setTimeout(function(){e.fadeOut(function(){t.loadNotifier.close()})},2e3)},_onCancelFile:function(e){var t=e.closest("li"),i=this.upload.wrapper,s=t.data("guid");i.find("li[data-uid="+s+"] .k-upload-action").trigger("click"),t.remove()},_onRemoveFile:function(e){e.closest("li").remove()},_onRetryFile:function(t){var i=t.closest("li").data("guid"),s=e.grep(this._fileList,function(e){return e.uid===i});this.options.retry(s[0])},onErrorFile:function(e){var t=this.options.localization,i=e.files[0],s=this._isValidFile(i),a=""!==s.message?s.message:t.errorUpload;this.setStatus("ERROR",i.uid,a)},_isValidFile:function(t){var i=this.options.localization,s=!0,a="";return(t.size>this._uploadMaxFilesSize||null==t.size||0==t.size)&&(a=i.errorSize,s=!1),this._onlyValidateServerFileExtension||-1===e.inArray(t.extension,this._supportFileExt)&&(a=i.errorSecurity,s=!1),{valid:s,message:a}},_filterMaxFilesSize:function(e){for(var t=0,i=0,s=e.files.length;i<s;i++)t+=e.files[i].size;t>this._maxFilesSize?(this._notifySizeExceeded(),e.preventDefault()):this._onShowUploadNotifier(e)},_notifySizeExceeded:function(){this.notification.show(this.options.localization.errorMaxFilesSize,"error")},_getFileItemByUID:function(t){return e("li[data-guid="+t+"]",this.loadNotifier.element)},_switchEvents:function(t){var i=e(".k-icon",t.currentTarget);i.hasClass("k-update")||i.hasClass("k-remove")?this._onRemoveFile(i):i.hasClass("k-retry")?this._onRetryFile(i):i.hasClass("k-cancel")&&this._onCancelFile(i)},_eventsHandler:function(){var e=this;e.loadNotifier.element.on("click","button.k-upload-action",function(t){e._switchEvents(t)})},cancelFilesUpload:function(){this.upload.wrapper.find("li .k-upload-action").trigger("click"),this.close()},close:function(){this.loadNotifier.close()},destroy:function(){this.loadNotifier.destroy(),this.upload.destroy()},setStatus:function(t,i,s){var a=this._getFileItemByUID(i),o=this.options.localization;switch(t){case"SUCCESS":a.removeClass("k-file-progress k-file-error").addClass("k-file-success"),e(".k-upload-action .k-icon",a).removeClass("k-cancel k-i-refresh k-retry").addClass("k-update").prop("title",o.close).show(),e(".k-errormsg",a).text("");break;case"ERROR":a.removeClass("k-file-progress").addClass("k-file-error"),e(".k-upload-action .k-icon",a).removeClass("k-i-refresh k-retry").addClass("k-remove").show(),e(".k-upload-status .k-upload-pct",a).removeClass("k-upload-pct k-loading").addClass("k-icon k-warning"),e(".k-errormsg",a).text(s).prop("title",s);break;case"RETRY":a.removeClass("k-file-progress").addClass("k-file-error"),e(".k-upload-status .k-upload-pct",a).removeClass("k-upload-pct k-loading").addClass("k-warning").text(""),e(".k-upload-action .k-icon",a).removeClass("k-cancel k-remove").addClass("k-i-refresh k-retry").prop("title",o.retry).show(),e(".k-errormsg",a).text(o.errorUpload).prop("title",o.errorUploadiis)}}});t.plugin(s)}(jQuery),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.discussions",{},{init:function(e,t,i,s){var a=this;a.typeResource="DiscussionGuid",a.plugins={},a.dialogBoxDiscussion={},a.attchComments={},a.attchDiscussions={remove:[],addition:[]},a.listDataDiscussion=[],a.userPictures=[],a.commentsList={},a.globalTags=[],a.tempTagsBeforeDelete=[],a.tempTagsToDelete=[],a.keySentenceAddTag=bizagi.localization.getResource("workportal-project-discussion-add-new-tag")+": ",a.notifier=i,a._super(e,t,s),a.loadTemplates({"project-discussions":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-wrapper"),"project-discussions-popup":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-popup-wrapper"),"project-discussions-list":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-list-wrapper"),"project-discussions-comments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-comments-list"),"project-discussions-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussions").concat("#project-discussions-attachments-list"),"project-attachments":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.attachments").concat("#project-attachments")})},renderContent:function(){var e=this.getTemplate("project-discussions");return this.content=e.render({}),this.content},postRender:function(){var e=this,t=e.getContent();e.plugins.popupDiscussion=e.initPluginPopupDiscussion();var i=e.plugins.popupDiscussion;e.form={buttonShowFormNewDiscussion:$(".ui-bizagi-wp-action-new",t),title:$(".ui-bizagi-wp-project-popupform-h4",i),subject:$("#ui-bizagi-wp-project-discussions-popup-subject-input",i),description:$("#ui-bizagi-wp-project-discussions-popup-description-textarea",i),buttonShowPopupDiscussionToAdd:$("#ui-bizagi-wp-project-discussions-button-action-show-popup-to-add",t),buttonAddDiscussion:$("#ui-bizagi-wp-project-discussions-popup-action-add-discussion",i),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",i),formDiscussion:$(".ui-bizagi-wp-project-discussions-popup",i),attachments:$(".ui-bizagi-wp-project-discussions-attachments-cmnwrapper",i),edition:!1},e.plugins.tagsFilter=e.initPluginTagsFilter(),e.plugins.tagsMultiSelect=e.initPluginTagsMultiSelect(i),e.getDiscussions(),e.eventsHandler(),e.restrictedEventsHandler()},getDiscussions:function(){var e=this;e.getDataDiscussions().done(function(){var t=$.map(e.listDataDiscussion,function(e){return e.user}),i=$.map(e.commentsList,function(e){return $.map(e.comments,function(e){return e.user})});var s=function(e){for(var t={},i=[],s=e.length,a=0,o=0;o<s;o++){var r=e[o];1!==t[r]&&(t[r]=1,i[a++]=r)}return i}(t.concat(i).concat(bizagi.currentUser.idUser)).join(",");e.getDataUsers(s).then(function(){e.renderUserProfilesAndImages()}),e.setClassesTagsByDiscussion()})},onNotifyOpenPopup:function(){this.form.edition=!1,this.showFormAddDiscussion("workportal-project-discussion-adddiscussion"),this.renderUserProfile()},initPluginPopupDiscussion:function(){var e=this.getTemplate("project-discussions-popup");return this.dialogBoxDiscussion.formContent=e.render({attachments:[]}),this.dialogBoxDiscussion.formContent},initPluginTagsMultiSelect:function(e){var t,i=this,s=e.find("#ui-bizagi-wp-project-discussions-options-multiselect-tags"),a=!1,o=!1;return s.kendoMultiSelect({change:function(){var e=this.value().slice(0),t=this.dataSource.data();e.length>0&&-1!==t[0].tag.replace(i.keySentenceAddTag,"").indexOf(e[e.length-1])&&(e[e.length-1]=t[0].tag.replace(i.keySentenceAddTag,"")),e=(e=e.filter(Boolean)).filter(function(e,t,i){return i.indexOf(e)===t});var s="";if(t.length>0&&-1!==t[0].tag.indexOf(i.keySentenceAddTag)){s=t[0].tag.replace(i.keySentenceAddTag,"");var r={};-1!==e.indexOf(s)?(r=this.dataSource.at(0),a=!0,this.dataSource.remove(r),a=!1,this.refresh(),o=!0):s&&($("li:first",this.list).hasClass("k-state-focused")&&(o=!0,e.push(s)),r=this.dataSource.at(0),a=!0,this.dataSource.remove(r),a=!1)}s&&(o&&(0===this.dataSource.data().filter(function(e){return e.tag===s}).length&&this.dataSource.add({guid:s,tag:s}),o=!1));this.dataSource.filter({}),this.value(e)},dataBound:function(){if((t||this._prev)&&t!==this._prev&&!a){t=this._prev;var e=this.dataSource.data(),s=!1;e.length>0&&-1!==e[0].tag.indexOf(i.keySentenceAddTag)&&(e[0].tag=i.keySentenceAddTag+t,this.refresh(),s=!0,$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused")),s||this.dataSource.insert(0,{tag:i.keySentenceAddTag+t,guid:t}),0==this.dataSource.total()&&(this.search(),this.open(),this.refresh(),$("li",this.list).removeClass("k-state-focused"),$("li:first",this.list).addClass("k-state-focused"))}},dataSource:[],dataTextField:"tag",dataValueField:"guid",filter:"contains",animation:!1}).data("kendoMultiSelect")},initPluginTagsFilter:function(){var e=this,t=e.getContent();return $("#ui-bizagi-wp-project-discussions-options-tags-filter",t).kendoMultiSelect({change:function(){e.hideOrShowDiscussionsByFilter()},autoClose:!1,tagMode:"single",dataTextField:"tag",dataValueField:"guid"}).data("kendoMultiSelect")},hideOrShowDiscussionsByFilter:function(){var e=this,t=e.plugins.tagsFilter.value();t.length>0?($(".ui-bizagi-wp-project-discussions-item",e.getContent()).hide(),t.forEach(function(t){$(".ui-bizagi-wp-project-discussions-item."+t,e.getContent()).show()})):$(".ui-bizagi-wp-project-discussions-item",e.getContent()).show()},validateAddCommentForm:function(e){var t=!1,i=$("textarea",e);if(""===i.val().trim()){var s=bizagi.localization.getResource("workportal-project-discussion-requiredcomment");i.parent().next().find("span").html(s)}else i.parent().next().find("span").empty(),t=!0;return t},validateAddDiscussionForm:function(e){var t=!1,i=$("#ui-bizagi-wp-project-discussions-popup-subject-input",e),s=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",e);if(""!==i.val().trim()&&""!==s.val().trim()&&(t=!0),""===i.val().trim()){var a=bizagi.localization.getResource("workportal-project-discussion-subjectrequired");i.parent().find("span").html(a)}else i.parent().find("span").empty();if(""===s.val().trim()){var o=bizagi.localization.getResource("workportal-project-discussion-requireddescription");s.parent().next().find("span").html(o)}else s.parent().next().find("span").empty();return t},applyFileAttachments:function(e){var t=this,i="DISCUSSIONS"===e?t.plugins.popupDiscussion:t.getContent();return $(".ui-bizagi-wp-project-discussions-attachment-upload",i).kendoProjectAttachments({saveUrl:t.dataService.serviceLocator.getUrl("project-comments-uploadfiles"),template:t.getTemplate("project-attachments"),success:function(i){t.onSuccessFile(i,e)},upload:$.proxy(t.addFileData,t),dropZone:!1,extensions:t.supportFileExt,maxSize:t.uploadMaxFilesSize}).data("kendoProjectAttachments")},addFileData:function(e){var t=e.files[0].uid;e.files[0].guid=t,e.data={guid:t}},getDataDiscussions:function(){var e=this,t=$.Deferred(),i={globalParent:e.radNumber,typeResource:e.typeResource};return"FLOW-DECONTEXTUALIZED-PLANS"===e.params.flowContext&&(i.globalParent=e.params.plan.id),e.dataService.getDiscussionsData(i).pipe(function(t){return e.callForListComments(t)}).done(function(i){e.listDataDiscussion=e.sortDiscussions(i),e.updateTemplateListDiscussion(),t.resolve()}),t.promise()},getDataUsers:function(e){var t=this,i=$.Deferred(),s={usersGuids:e,width:50,height:50};return s.usersGuids?t.dataService.getUsersData(s).always(function(e){t.userPictures=function(e){for(var t=e.concat(),i=0;i<t.length;++i)for(var s=i+1;s<t.length;++s)t[i]===t[s]&&t.splice(s--,1);return t}(t.userPictures.concat(e)),i.resolve()}):i.resolve(),i.promise()},callForListComments:function(e){for(var t=this,i=$.Deferred(),s=[],a=0,o=e.length-1;a<=o;a++){t.addGlobalTags(e[a].tags,!1);var r={idParent:e[a].guid,dateTime:t.getDateServer(),count:6};t.commentsList[r.idParent]={comments:[],count:0,total:0};var n=$.when(t.dataService.getCommentsData(r)).done(function(e){e.length>0&&(t.commentsList[e[0].parent]={comments:e,count:e.length,total:0})});s.push(n)}return $.when.apply($,s).done(function(){i.resolve(e)}),i.promise()},sortDiscussions:function(e){var t=[];return e.length&&(t=e.sort(function(e,t){var i=e.date;return t.date-i})).length>0&&t.unshift(t.pop()),t},resetDiscussionAttachments:function(){var e=this,t=e.plugins.popupDiscussion;$(".ui-bizagi-wp-project-attachments-list",t).empty(),e.plugins.tagsMultiSelect.value([]),e.attchDiscussions.addition=[],e.attchDiscussions.remove=[],e.getDiscussions()},sendDataUpdateDiscussion:function(e){var t=this,i=t.prepareFilesToSave();t.form.buttonAddDiscussion.prop("disabled",!0);var s=t.getTagsDiscussionBySave(),a=t.getGuidsTagsDiscussionToDelete(),o={content:{name:t.form.subject.val(),description:t.form.description.val(),globalParent:t.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:e,tags:s,typeResource:"DiscussionGuid",general:!1,date:t.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};t.plugins.attchDiscussions.close(),t.dataService.editDiscussion(o).always(function(i){if(200===i.status||201===i.status||void 0===i.status){t.addGlobalTags(s,!0);var r=t.getDiscussionDataByGUID(e);r.name=o.content.name,r.description=o.content.description,r.attachments=o.content.attachments,r.tags=o.content.tags,t.onClosePopupDiscussion(),t.resetDiscussionAttachments(),t.updateTemplateListDiscussion(),t.removeGlobalTags(a),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-edited"),""))}else t.form.buttonAddDiscussion.prop("disabled",!1),t.onClosePopupDiscussion(),t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-edition"),""));t.renderUserProfilesAndImages(),t.setClassesTagsByDiscussion(),t.hideOrShowDiscussionsByFilter()})},validateStringIsGuid:function(e){return/^({|()?[0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12}(}|))?$/.test(e)&&!/^({|()?0{8}-(0{4}-){3}0{12}(}|))?$/.test(e)},sendDataInsertDiscussion:function(e){var t=this,i=t.prepareFilesToSave();t.form.buttonAddDiscussion.prop("disabled",!0);var s=t.getTagsDiscussionBySave(),a={content:{name:t.form.subject.val(),description:t.form.description.val(),globalParent:t.radNumber.toString(),user:bizagi.currentUser.idUser,attachments:i.attachments,guid:e,tags:s,typeResource:"DiscussionGuid",general:!1,date:t.getDateServer()},attachmentsToCreate:i.attachmentsToCreate,attachmentsToDelete:i.attachmentsToDelete};t.plugins.attchDiscussions.close(),t.dataService.postDiscussion(a).always(function(e){if(200===e.status||201===e.status||void 0===e.status){t.addGlobalTags(s,!0),t.form.buttonAddDiscussion.prop("disabled",!1);var i={name:a.content.name,description:a.content.description,date:a.content.date,user:a.content.user,attachments:a.content.attachments,radNumber:a.content.globalParent,general:a.content.general,guid:a.content.guid,tags:a.content.tags,typeResource:a.content.typeResource};t.commentsList[a.content.guid]={comments:[],count:0,total:0},0===t.listDataDiscussion.length?t.listDataDiscussion.push(i):t.listDataDiscussion.splice(1,0,i),t.resetDiscussionAttachments(),t.onClosePopupDiscussion(),t.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-discussion-created"),"")),t.updateTemplateListDiscussion()}else t.form.buttonAddDiscussion.prop("disabled",!1),t.onClosePopupDiscussion(),t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-error-creation"),""));t.renderUserProfilesAndImages(),t.setClassesTagsByDiscussion(),t.hideOrShowDiscussionsByFilter()})},getTagsDiscussionBySave:function(){var e=this,t=e.plugins.tagsMultiSelect.value(),i=e.plugins.tagsMultiSelect.dataSource.data(),s=[];return t.forEach(function(t){var a,o=e.validateStringIsGuid(t);1===(a=o?i.filter(function(e){return e.guid===t}):i.filter(function(i){var s=e.validateStringIsGuid(i.guid);return i.tag===t&&!s})).length&&s.push({guid:o?a[0].guid:a[0].uid,tag:a[0].tag})}),s},differenceArrays:function(e,t){return e.filter(function(e){return t.indexOf(e)<0})},getGuidsTagsDiscussionToDelete:function(){var e=this.plugins.tagsMultiSelect.value();return this.differenceArrays(this.tempTagsBeforeDelete,e)},setStateUIShowMoreComments:function(e,t){var i=e.siblings(".ui-bizagi-wp-project-discussion-showmore-comments"),s=i.find(".ui-bizagi-wp-project-discussion-showmore-comments-button"),a=i.find(".ui-bizagi-wp-project-discussion-showmore-no-more-comments"),o=i.find(".ui-bizagi-wp-project-discussion-showmore-loading-comments");"ALLOW_MORE_COMMENTS"===t&&(s.show(),a.hide(),o.hide()),"LOADING_MORE_COMMENTS"===t&&(s.hide(),a.hide(),o.show()),"NO_MORE_COMMENTS"===t&&(s.hide(),a.show(),o.hide())},getCurrentUserInfo:function(){return{name:bizagi.currentUser.userName,id:bizagi.currentUser.idUser,picture:""}},addGlobalTags:function(e,t){for(var i=this,s=0;s<e.length;s+=1){0===i.globalTags.filter(function(t){return t.tag===e[s].tag}).length&&(e[s].globalParent=i.radNumber,i.globalTags.push(e[s]),t&&i.dataService.postTag(e[s]))}i.plugins.tagsFilter.dataSource.data(i.globalTags),i.plugins.tagsMultiSelect.dataSource.data(i.globalTags)},removeGlobalTags:function(e){var t=this,i=$.map(t.listDataDiscussion,function(e){return $.map(e.tags,function(e){return e.guid})}).concat(e),s=[];e.forEach(function(e){1===i.filter(function(t){return t===e}).length&&s.push(e)}),s.forEach(function(e){var i={idTag:e};t.dataService.deleteTag(i);for(var s=t.globalTags.length-1;s>=0;s-=1)t.globalTags[s].guid===e&&t.globalTags.splice(s,1)}),t.plugins.tagsFilter.dataSource.data(t.globalTags),t.plugins.tagsMultiSelect.dataSource.data(t.globalTags)},setClassesTagsByDiscussion:function(){for(var e=0;e<this.listDataDiscussion.length;e+=1){var t=$.map(this.listDataDiscussion[e].tags,function(e){return e.guid}).join(" ");$(".ui-bizagi-wp-project-discussions-item[data-guid='"+this.listDataDiscussion[e].guid+"']",this.getContent()).addClass(t)}},updateTemplateListDiscussion:function(){for(var e=this,t=e.getContent(),i=e.getTemplate("project-discussions-list"),s=e.getCurrentUserInfo(),a=i.render({listDataDiscussions:e.listDataDiscussion,user:s,isOpen:!bizagi.util.parseBoolean(e.params.isClosedForAllUsers),returnServedCommentByParentId:function(t){return e.returnServedCommentByParentId(t)}}),o=0;o<this.listDataDiscussion.length;o++)this.mapTempComments($("#ui-bizagi-wp-project-discussions-list-wrapper",t).find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[o].guid+"]"),a.find(".ui-bizagi-wp-project-discussions-container-description-and-comments[data-guid="+this.listDataDiscussion[o].guid+"]"));$("#ui-bizagi-wp-project-discussions-list-wrapper",t).empty().append(a),e.plugins.attchComments=e.applyFileAttachments("COMMENTS")},showFormAddDiscussion:function(e){var t=this;t.plugins.attchComments&&t.plugins.attchComments.close(),t.dialogBoxDiscussion.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"650px",modal:!0,zIndex:1,title:bizagi.localization.getResource(e),maximize:!0,open:$.proxy(t.onOpenPopupDiscussion,t),close:function(){t.resetDiscussionAttachments(),t.onClosePopupDiscussion()}})},resetFormDiscussion:function(){var e=this;e.form.buttonAddDiscussion.prop("disabled",!1),e.form.subject.val(""),e.form.description.val("");var t=$("#ui-bizagi-wp-project-discussions-popup-subject-input",e.dialogBoxDiscussion.formContent),i=$("#ui-bizagi-wp-project-discussions-popup-description-textarea",e.dialogBoxDiscussion.formContent);t.parent().find("span").empty(),i.parent().next().find("span").empty()},renderUserProfile:function(){var e=$.grep(this.userPictures,function(e){return e.id===bizagi.currentUser.idUser})[0],t=$(".ui-bizagi-wp-project-popupform-user"),i=t.find(".bz-wp-avatar-img"),s=t.find(".bz-wp-avatar-label");e&&(e.picture?i.attr("src","data:image/png;base64,"+e.picture):(i.hide(),s.html(e.name.getInitials()).show()))},renderUserProfilesAndImages:function(){var e=this,t=$.grep(e.userPictures,function(e){return e.id===bizagi.currentUser.idUser})[0],i="data:image/png;base64,";t&&($(".ui-bizagi-wp-project-discussions-create-comment .bz-wp-discussion-username").html(t.name),t.picture?($(".ui-bizagi-wp-project-discussions-item-user img").attr("src",i+t.picture),$(".ui-bizagi-wp-project-popupform-image-current-user").attr("src",i+t.picture)):($(".ui-bizagi-wp-project-discussions-item-user label.bz-wp-avatar-label").html(t.name.getInitials()).show(),$(".ui-bizagi-wp-project-discussions-item-user img").hide()));for(var s=0;s<e.userPictures.length;s++)$("div[data-iduser='"+e.userPictures[s].id+"'] .bz-wp-discussion-username").html(e.userPictures[s].name),e.userPictures[s].picture?$("div[data-iduser='"+e.userPictures[s].id+"'] .bz-wp-avatar-img").attr("src",i+e.userPictures[s].picture):($("div[data-iduser='"+e.userPictures[s].id+"'] .bz-wp-avatar-img").hide(),$("div[data-iduser='"+e.userPictures[s].id+"'] label.bz-wp-avatar-label").html(e.userPictures[s].name.getInitials()))},switchCommentsEvents:function(e){var t=this,i=$(e.target),s=i.parent();if(i.is("textarea"))t.onShowButtonsPanel(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-cancel"))t.onCancelComment(i);else if(i.hasClass("ui-bizagi-wp-project-discussions-comment-buttons-share")){var a=i.closest(".ui-bizagi-wp-project-discussions-add-comment");if(t.validateAddCommentForm(a)){var o=Math.guid();t.onCreateComment(i,o)}}else i.hasClass("ui-bizagi-wp-project-discussions-comment-view")?t.onViewComment(i):i.hasClass("ui-bizagi-wp-project-discussion-showmore-comments-button")?t.onViewMoreComments(i):i.hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?t.onRemoveFiles(i):s.hasClass("biz-wp-user-icon-admin")&&s.hasClass("biz-wp-action-edit-discussion")?t.onEditDiscussion(i):s.hasClass("ui-bizagi-wp-project-discussion-delete")?$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-discussion-querydelete"),"","info")).done(function(){t.onDeleteComment(s)}):s.hasClass("bz-bizagi-wp-project-discussions-attachment-itemwrapper")&&t.onDownloadAttachment(i.closest("li"));e.stopPropagation()},onEditDiscussion:function(e){var t=e.closest(".ui-bizagi-wp-project-discussions-item").data("guid");this.setDiscussionsDataByGUID(t),this.showFormAddDiscussion("workportal-project-discussion-edit")},setDiscussionsDataByGUID:function(e){var t=this,i=t.getDiscussionDataByGUID(e),s=$(".ui-bizagi-wp-project-attachments-list",t.form.attachments);t.form.edition={guid:e},t.attchDiscussions={addition:i.attachments,remove:[]},t.form.title.text(bizagi.localization.getResource("workportal-project-discussion-edit")),t.form.subject.val(i.name),t.form.description.val(i.description);var a=$.map(i.tags,function(e){return e.guid});t.plugins.tagsMultiSelect.value(a),t.tempTagsBeforeDelete=[],t.tempTagsBeforeDelete=t.tempTagsBeforeDelete.concat(t.plugins.tagsMultiSelect.value()),t.renderAttachments(i.attachments,"DISCUSSIONS",s)},getDiscussionDataByGUID:function(e){for(var t,i=this.listDataDiscussion.length-1;i>=0;i--)this.listDataDiscussion[i].guid===e&&(t=this.listDataDiscussion[i],i=0);return t},onViewComment:function(e){var t=e.closest(".ui-bizagi-wp-project-discussions-comment-truncatewrapper");t.toggleClass("ui-bizagi-wp-project-discussions-comment-shortcomment"),t.toggleClass("ui-bizagi-wp-project-discussions-comment-longcomment")},onViewMoreComments:function(e){var t=this,i=e.closest(".ui-bizagi-wp-project-discussion-showmore-comments").siblings(".ui-bizagi-wp-project-discussion-comment-list"),s=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid");t.commentsList[s].total?t.getMoreComments(s,i):t.dataService.getCommentsCountByParent(s).done(function(e){t.commentsList[s].total=e.count,t.getMoreComments(s,i)})},getMoreComments:function(e,t){var i,s=this;s.commentsList[e].total>s.commentsList[e].comments.length?(s.setStateUIShowMoreComments(t,"LOADING_MORE_COMMENTS"),i=0===s.commentsList[e].comments.length?s.getDateServer():s.commentsList[e].comments[s.commentsList[e].comments.length-1].date,i-=1,s.dataService.getCommentsData({dateTime:i,idParent:e,count:6}).done(function(i){if(i.length){Array.prototype.push.apply(s.commentsList[e].comments,i),s.commentsList[e].count+=i.length,s.renderCommentByDiscussion(t,e,i),s.renderUserProfilesAndImages(),i.length>5?s.setStateUIShowMoreComments(t,"ALLOW_MORE_COMMENTS"):s.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS");var a=$.map(s.userPictures,function(e){return e.id}),o=$.map(s.commentsList,function(e){return $.map(e.comments,function(e){return e.user})}),r=$(o).not(a).get().join(",");s.getDataUsers(r).then(function(){s.renderUserProfilesAndImages()})}else s.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS")}).fail(function(){s.setStateUIShowMoreComments(t,"ALLOW_MORE_COMMENTS")})):s.setStateUIShowMoreComments(t,"NO_MORE_COMMENTS")},renderCommentByDiscussion:function(e,t,i){var s,a=this.getTemplate("project-discussions-comments"),o={comments:[],user:this.getCurrentUserInfo(),isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)};i.length?(o.comments=i,s=a.render(o),e.append(s)):(o.comments=this.commentsList[t].comments,s=a.render(o),e.html(s))},getCommentByGuid:function(e,t){for(var i=this.commentsList[e].comments,s=0,a=i.length;s<a;s++)if(i[s].guid===t){for(var o=[],r=0,n=i[s].attachments.length;r<n;r++)o.push(i[s].attachments[r].guid);return{attachments:o,index:s}}return{}},returnServedCommentByParentId:function(e){if(void 0!==this.commentsList[e])return this.commentsList[e]},onShowButtonsPanel:function(e){e.closest(".ui-bizagi-wp-project-discussions-add-comment").find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper").show()},onRemoveFiles:function(e){var t,i,s,a=e.closest("li"),o=a.closest(".ui-bizagi-wp-project-attachments-list").data("type"),r=a.data("fileguid");if("COMMENT"===o){var n=a.closest(".ui-bizagi-wp-project-discussions-add-comment").data("guid");t=this.attchComments[n].addition,i=this.attchComments[n].remove}else t=this.attchDiscussions.addition,i=this.attchDiscussions.remove;for(var c=0,u=t.length-1;c<=u;c++)t[c].guid===r&&(s=t.splice(c,1),i.push(s[0].guid),c=u);a.remove()},onDeleteComment:function(e){var t=this,i=e.closest(".ui-bizagi-wp-project-discussions-item-comment"),s=i.data("cmmtguid"),a=i.closest(".ui-bizagi-wp-project-discussions-container-description-and-comments").data("guid"),o=t.getCommentByGuid(a,s),r={content:{guid:s},attachmentsToDelete:o.attachments};$.when(t.dataService.deleteComment(r)).always(function(e){200===e.status||void 0===e.status?(t.commentsList[a].comments.splice(o.index,1),i.remove()):t.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-discussion-errordelete"),""))})},onSuccessFile:function(e,t){var i=this,s=e.files;if((e.XMLHttpRequest.response?JSON.parse(e.XMLHttpRequest.response):{}).error)"DISCUSSIONS"===t?i.plugins.attchDiscussions.onErrorFile(e):i.plugins.attchComments.onErrorFile(e);else{var a=$(e.sender.element).closest(".ui-bizagi-wp-project-discussion-textwrapper"),o=a.find(".ui-bizagi-wp-project-attachments-list");if("DISCUSSIONS"===t)i.plugins.attchDiscussions.setStatus("SUCCESS",s[0].guid),Array.prototype.push.apply(i.attchDiscussions.addition,s);else{i.plugins.attchComments.setStatus("SUCCESS",s[0].guid);var r=a.data("guid");i.attchComments[r]?Array.prototype.push.apply(i.attchComments[r].addition,s):i.attchComments[r]={addition:s,remove:[]},i.onShowButtonsPanel(o.parent())}i.renderAttachments(s,t,o)}},onDownloadAttachment:function(e){var t=e.data("fileguid");if(""!==t){var i=e.find(".bz-bizagi-wp-project-discussions-attachment-filename").text();this.dataService.getDownloadAttachment(t,i)}},onCancelComment:function(e){var t=e.closest(".ui-bizagi-wp-project-discussions-add-comment"),i=t.find(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),s=t.find("textarea"),a=t.find(".ui-bizagi-wp-project-discussions-add-attachments form"),o=t.find(".k-tooltip-validation"),r=t.find(".ui-bizagi-wp-project-attachments-list"),n=t.data("guid");this.attchComments[n]={addition:[],remove:[]},this.plugins.attchComments.cancelFilesUpload(),a[0].reset(),r.empty(),s.val(""),o.hide(),i.hide()},onCreateComment:function(e,t){var i=this,s=e.closest(".ui-bizagi-wp-project-discussions-item-comment"),a=e.closest(".ui-bizagi-wp-project-discussions-comment-buttons-wrapper"),o=e.closest(".ui-bizagi-wp-project-discussions-add-comment"),r=o.find("textarea"),n=o.find(".ui-bizagi-wp-project-attachments-list"),c=o.data("guid"),u=i.prepareFilesToSave("COMMENTS",c),p={content:{guid:t,attachments:u.attachments,text:r.val(),parent:c,date:i.getDateServer(),user:bizagi.currentUser.idUser},attachmentsToCreate:u.attachmentsToCreate,attachmentsToDelete:u.attachmentsToDelete};$.when(i.dataService.postComment(p)).always(function(e){if(200===e.status||201===e.status||void 0===e.status){var t=s.siblings(".ui-bizagi-wp-project-discussion-comment-list"),o={user:p.content.user,attachments:p.content.attachments,text:p.content.text,guid:p.content.guid,parent:p.content.parent,date:p.content.date};i.attchComments[p.content.parent]={addition:[],remove:[]},r.val(""),n.empty(),a.hide(),i.commentsList[o.parent].comments.unshift(o),i.renderCommentByDiscussion(t,o.parent,[]),i.plugins.attchComments.close(),i.renderUserProfilesAndImages()}})},renderAttachments:function(e,t,i){var s=this.getTemplate("project-discussions-attachments").render({attachments:e,type:t});i.append(s),bizagi.util.isIE()&&$(".ui-bizagi-wp-project-attachments-list li").hide(10,function(){$(this).show()})},prepareFilesToSave:function(e,t){for(var i=[],s="COMMENTS"===e?this.attchComments[t]:this.attchDiscussions,a=[],o=0,r=(s=s||{addition:[],remove:[]}).addition.length-1;o<=r;o++)i.push({guid:s.addition[o].guid,name:s.addition[o].name}),a.push(s.addition[o].guid);return{attachments:i,attachmentsToCreate:a,attachmentsToDelete:s.remove}},onClickCancel:function(e){e.preventDefault();this.resetDiscussionAttachments(),this.onClosePopupDiscussion(),this.plugins.attchDiscussions.cancelFilesUpload()},onClosePopupDiscussion:function(){this.resetFormDiscussion(),this.plugins.attchDiscussions.destroy(),this.dialogBoxDiscussion.formContent.dialog("destroy"),this.dialogBoxDiscussion.formContent.detach()},onOpenPopupDiscussion:function(){var e=this;e.plugins.attchDiscussions=e.applyFileAttachments("DISCUSSIONS"),e.dialogBoxDiscussion.formContent.parent().css("z-index",10001),e.dialogBoxDiscussion.formContent.parent().parent().find(".ui-widget-overlay").css("z-index",10001),setTimeout(function(){e.form.subject.focus()},50)},onSubmitFormDiscussion:function(e){e.preventDefault();var t,i=this;i.validateAddDiscussionForm(i.dialogBoxDiscussion.formContent)&&(i.form.edition.guid?(t=i.form.edition.guid,$.proxy(i.sendDataUpdateDiscussion(t),i)):(t=Math.guid(),$.proxy(i.sendDataInsertDiscussion(t),i)))},restrictedEventsHandler:function(){var e=this.getContent();$("#ui-bizagi-wp-project-discussions-list-wrapper",e).on("click",".bz-bizagi-wp-project-discussions-attachment-itemwrapper",$.proxy(this.switchCommentsEvents,this))},eventsHandler:function(){var e=this,t=e.getContent();e.form.buttonShowFormNewDiscussion.on("click",$.proxy(e.onNotifyOpenPopup,e)),e.form.buttonCancel.on("click",$.proxy(e.onClickCancel,e)),e.form.buttonAddDiscussion.on("click",$.proxy(e.onSubmitFormDiscussion,e)),e.form.attachments.on("click",".bz-bizagi-wp-project-discussions-attachment-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper",function(t){$(t.target).hasClass("bz-bizagi-wp-project-discussions-attachment-delete")?e.onRemoveFiles($(t.target)):e.onDownloadAttachment($(t.target).closest("li")),t.stopPropagation()}),$("#ui-bizagi-wp-project-discussions-list-wrapper",t).on("click",".ui-bizagi-wp-project-discussions-add-comment textarea, .ui-bizagi-wp-project-discussions-comment-buttons-cancel, .ui-bizagi-wp-project-discussions-comment-buttons-share, .ui-bizagi-wp-project-discussion-showmore-comments button, .bz-bizagi-wp-project-discussions-attachment-delete, .ui-bizagi-wp-project-discussion-delete, .bz-bizagi-wp-project-discussions-attachment-itemwrapper, .ui-bizagi-wp-project-discussions-comment-view, .ui-bizagi-wp-project-discussions-items-edition, .biz-wp-action-edit-discussion",$.proxy(e.switchCommentsEvents,e)),e.sub("changeProjectWidget",function(){e.resetWidget()}),e.sub("OPEN_POPUP_DISCUSSION",$.proxy(e.onNotifyOpenPopup,e))},resetWidget:function(){this.userPictures=[],this.plugins.attchComments&&this.plugins.attchComments.close()},clean:function(){var e=this;for(var t in e.resetWidget(),e.form&&e.form.buttonShowFormNewDiscussion&&e.form.buttonShowFormNewDiscussion.off("click",$.proxy(e.onNotifyOpenPopup,e)),e.plugins)e.plugins[t]&&e.plugins[t].hasOwnProperty("destroy")&&e.plugins[t].destroy&&e.plugins[t].destroy()},mapTempComments:function(e,t){var i=e.find("textarea"),s=t.find("textarea"),a=e.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first(),o=t.find(".ui-bizagi-wp-project-attachments-list[data-type=COMMENT]").first();s.val(i.val()),o.empty().append(a.html())}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussions",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.discussions],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.discussion.sidebar",{},{init:function(e,t,i){this._super(e,t,i),(i=i||{}).supportNav=!1,this.loadTemplates({"project-discussion-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.discussion.sidebar").concat("#project-discussion-sidebar")})},renderContent:function(){var e=this.getTemplate("project-discussion-sidebar");return this.content=e.render({isOpen:!bizagi.util.parseBoolean(this.params.isClosedForAllUsers)}),this.content},postRender:function(){var e=this.getContent();$(".ui-bizagi-wp-project-discussions-sidebar-action-add > a",e).on("click",$.proxy(this.onShowPopupDiscussion,this))},onShowPopupDiscussion:function(){this.pub("notify",{type:"OPEN_POPUP_DISCUSSION",args:{}})}}),bizagi.injector.register("bizagi.workportal.widgets.project.discussion.sidebar",["workportalFacade","dataService",bizagi.workportal.widgets.project.discussion.sidebar],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.caseState",{},{init:function(e,t,i){var s=this;s._super(e,t,i),s.contextsSidebarActivity=i.contextsSidebarActivity,s.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),s.loadTemplates({"project-caseState":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.caseState").concat("#project-caseState-wrapper"),"project-caseState-popup-release":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.caseState").concat("#project-caseState-popup-release"),"project-caseState-remaining":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.caseState").concat("#project-caseState-remaining")}),s.releaseDialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.releaseDialogBox.formContent=this.getTemplate("project-caseState-popup-release").render({}),this.content},postRender:function(){var e=this;(e.contextsSidebarActivity||[]).forEach(function(t){e.sub(t,$.proxy(e.updateView,e))}),e.plugins={},e.plugins.popupRelease={form:{buttonAccept:$("#button-accept-release",e.releaseDialogBox.formContent),buttonCancel:$("#button-cancel-release",e.releaseDialogBox.formContent)}},e.plugins.popupRelease.form.buttonAccept.on("click",$.proxy(e.onClickAcceptRelease,e)),e.plugins.popupRelease.form.buttonCancel.on("click",$.proxy(e.onClickCancelRelease,e))},updateView:function(e,t){var i=this;$.extend(i.params,t.args);var s=t.args;i.getContent().empty();var a={isFavoriteCase:"off"};if(s.isFavorite&&JSON.parse(s.isFavorite)?a.isFavoriteCase="bz-icon-star":a.isFavoriteCase="bz-icon-star-outline",i.showCaseNumber(s,a),s.creationDate){var o="MM/dd/yyyy H:mm",r=s.creationDate,n=bizagi.util.dateFormatter.getDateFromFormat(r,o);a.creationDateFormat=i.getFormattedDate(n);var c=bizagi.util.dateFormatter.getDateFromFormat(s.solutionDate,o);a.solutionDateFormat=i.getFormattedDate(c);var u=new Date;i.calculateDataForTemplate(a,n,u,c,s)}$(i.getContent()).on("click",".show-diagram-case",function(){!(!i.params.isAdhocProcess||void 0===i.params.isAdhocProcess)?i.showGraphicQuery({idCase:i.params.idCaseForGraphicQuery||i.params.idCase,idWorkflow:i.params.idWorkFlow,isAdhoc:!0,idProcess:i.params.idAdhocProcess}):i.showGraphicQuery({idCase:i.params.idCaseForGraphicQuery||i.params.idCase,idWorkflow:i.params.idWorkFlow})}),$(i.getContent()).on("click",".show-process-help",function(){i.showHelpUrl(i.params.helpUrl)})},calculateDataForTemplate:function(e,t,i,s,a){var o=this.getContent(),r={};r.idUser=bizagi.currentUser.idUser,bizagi.util.parseBoolean(a.isOpen)?(r.fromDate=t.getTime(),r.toDate=i.getTime()):(r.fromDate=s.getTime(),r.toDate=i.getTime());var n=r.toDate-r.fromDate,c=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-n),null,!1);bizagi.util.parseBoolean(a.isOpen)?(e.relativeTimeState=bizagi.localization.getResource("workportal-project-case-state-opened").replace("%s",c),e.colorStateCase="Opened"):(e.relativeTimeState=bizagi.localization.getResource("workportal-project-case-state-closed").replace("%s",c),e.colorStateCase="Closed"),e.percentCompleteBar=100,e.isOpen=bizagi.util.parseBoolean(a.isOpen),this.getTemplate("project-caseState-remaining").render($.extend(a,e)).appendTo($("#ui-bizagi-remaining",o))},showCaseNumber:function(e,t){var i=this,s=i.getContent(),a=i.getTemplate("project-caseState"),o=!1;o=!(!this.params.isAdhocProcess||void 0===this.params.isAdhocProcess)&&this.params.isAdhocProcess,i.params.helpUrl=bizagi.util.validateUrlWellFormed(i.params.helpUrl),a.render($.extend(e,t,{security:bizagi.menuSecurity,isAdhocProcess:o,urlHelp:!bizagi.util.isEmpty(i.params.helpUrl)})).appendTo(s),$(".case-summary-favorite",s).on("click",$.proxy(i.onClickFavorite,i)),$(".case-summary-back",i.content).on("click",$.proxy(i.goToCase,i,"back")),$(".case-summary-next",i.content).on("click",$.proxy(i.goToCase,i,"next")),i.showBackNextNavigation()},getFormattedDate:function(e){var t=this.datePickerRegional.monthNames,i=e.getMonth(),s=BIZAGI_LANGUAGE;return null!=s&&null!=s&&s.length>0&&"fr"==s.substring(0,2)?$.datepicker.formatDate("dd",e)+" "+t[i]:t[i]+" "+$.datepicker.formatDate("dd",e)},onClickFavorite:function(e){e.preventDefault();var t=this,i={};$(e.target).hasClass("bz-icon-star-outline")?(i={idObject:t.params.idCase,favoriteType:"CASES"},$.when(t.dataService.addFavorite(i)).done(function(i){t.params.guidFavorite=i.idFavorites,$(e.target).removeClass("bz-icon-star-outline"),$(e.target).addClass("bz-icon-star")})):(i={idObject:t.params.guidFavorite,favoriteType:"CASES"},$.when(t.dataService.delFavorite(i)).done(function(){$(e.target).addClass("bz-icon-star-outline"),$(e.target).removeClass("bz-icon-star")}))},showHelpUrl:function(e){window.open(e)},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"reassing":this.onClickMenuReasign();break;case"release":this.onClickMenuRelease()}},onClickMenuReasign:function(){var e=this,t=e.params.idCase,i=e.params.idWorkitem;bizagi.loader.startAndThen("admin").then(function(){$.when(e.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_REASSIGN_CASE,data:{idCase:t,idWorkItem:i},closeVisible:!1,maximize:!0,modalParameters:{title:bizagi.localization.getResource("render-actions-reassign"),width:"910px",id:"CaseAdmin"}}))})},onClickMenuRelease:function(){var e=this;e.releaseDialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"660px",modal:!0,title:bizagi.localization.getResource("workportal-widget-dialog-box-release-ok"),maximize:!0,close:function(){e.releaseDialogBox.formContent.dialog("destroy"),e.releaseDialogBox.formContent.detach()}})},onClickAcceptRelease:function(){var e=this,t={idCase:e.params.idCase,idWorkItem:e.params.idWorkitem};$.when(e.dataService.releaseActivity(t)).done(function(i){var s;switch(i.status?i.status:""){case"Success":e.publish("changeWidget",{widgetName:bizagi.workportal.currentInboxView});break;case"ConfigurationError":s=e.getResource("workportal-widget-dialog-box-release-configuration-error-message").replace("{0}",t.idWorkItem),bizagi.showMessageBox(s,e.getResource("workportal-widget-dialog-box-release-error"),"error",!1);break;default:s=e.getResource("workportal-widget-dialog-box-release-error-message").replace("{0}",t.idWorkItem),bizagi.showMessageBox(s,e.getResource("workportal-widget-dialog-box-release-error"),"error",!1)}}).fail(function(){var i=e.getResource("workportal-widget-dialog-box-release-error-message").replace("{0}",t.idWorkItem);bizagi.showMessageBox(i,e.getResource("workportal-widget-dialog-box-release-error"),"error",!1)}),e.releaseDialogBox.formContent.dialog("destroy"),e.releaseDialogBox.formContent.detach()},onClickCancelRelease:function(){this.releaseDialogBox.formContent.dialog("destroy"),this.releaseDialogBox.formContent.detach()},callGetEffectiveDuration:function(e){var t=$.Deferred();return e.fromDate?$.when(this.dataService.getEffectiveDuration(e)).done(function(e){t.resolve(e)}):t.resolve(null),t.promise()},clean:function(){var e=this;$(".show-diagram-case",e.getContent()).off();var t=e.contextsSidebarActivity||[];this.params={},t.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})},goToCase:function(e){var t="back"==e?this.getBackCase():this.getNextCase();t>0&&this.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:t})},getListKey:function(){if(bizagi.lstIdCases=bizagi.lstIdCases||{},bizagi.lstIdCases.length>1)for(var e=0;e<bizagi.lstIdCases.length;e++)if(this.params.idCase==bizagi.lstIdCases[e])return e;return-1},getNextCase:function(){var e=this.getListKey();return bizagi.lstIdCases.length==e+1||1==bizagi.lstIdCases.length?-1:bizagi.lstIdCases[e+1]},getBackCase:function(){var e=this.getListKey();return 0==e?-1:bizagi.lstIdCases[e-1]||-1},showBackNextNavigation:function(){var e=this,t=e.getNextCase(),i=e.getBackCase();t<=0?$(".case-summary-next",e.content).hide():$(".case-summary-next",e.content).show(),i<=0?$(".case-summary-back",e.content).hide():$(".case-summary-back",e.content).show(),t<=0&&i<=0?($(".content-right-sidebar").removeClass("bz-state-number--active-case"),$(".bz-case-navigation").hide()):($(".content-right-sidebar").addClass("bz-state-number--active-case"),$(".bz-case-navigation").show())}}),bizagi.injector.register("bizagi.workportal.widgets.project.caseState",["workportalFacade","dataService",bizagi.workportal.widgets.project.caseState]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.activityState",{},{init:function(e,t,i){this._super(e,t,i),this.contextsSidebarActivity=i.contextsSidebarActivity,this.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),this.loadTemplates({"project-activityState-wrapper":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.activityState").concat("#project-activityState-wrapper")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.contextsSidebarActivity.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var i=this,s=t.args;i.params=s,i.getContent();var a={},o=s.currentState||[],r=o.filter(function(e){return e.idWorkItem==s.idWorkitem})[0];if(r){a.activityName=r.state,a.activityIsEvent=bizagi.util.parseBoolean(r.isEvent);var n="MM/dd/yyyy H:mm",c=bizagi.util.dateFormatter.getDateFromFormat(r.entryDateWorkItem,n);c.getTime&&(a.initDateFormat=i.getFormattedDate(c));var u=new Date,p=bizagi.util.dateFormatter.getDateFromFormat(r.estimatedSolutionDate,n);a.estimatedSolutionDateFormat="",c.getTime&&p.getTime&&r?i.calculateDataForTemplate(r,a,c,u,p,o):i.updateTemplateWidget(a,o)}},initilizeActionMenu:function(e){var t=this,i=!1;if(e&&e.length>0)for(j=0;j<e.length;++j)e[j]&&t.params&&e[j].idWorkItem==t.params.idWorkitem&&(i=bizagi.util.parseBoolean(e[j].allowsReassign)||!1);var s=$("#bt-case-action-reassing",t.content),a=$("#ui-bizagi-wp-project-activity-button:not(.ui-bizagi-wp-project-activity-shared)",t.content);i&&s.show(),s.on("click",function(){t.onClickMenuReasign()}),a.on("click",function(){t.onClickShareActivity()})},onClickMenuReasign:function(){var e=this,t=e.params.idCase,i=e.params.idWorkitem;bizagi.loader.startAndThen("admin").then(function(){$.when(e.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_REASSIGN_CASE,data:{idCase:t,idWorkItem:i},closeVisible:!1,maximize:!0,modalParameters:{title:bizagi.localization.getResource("render-actions-reassign"),width:"910px",id:"CaseAdmin"}}))})},onClickShareActivity:function(){var e={idWorkItem:this.params.idWorkitem},t=$("#ui-bizagi-wp-project-activity-button",this.content);t.attr("disabled",!0),$.when(this.dataService.getShareActivity(e)).done(function(e){var i=window.parent.bizagi.injector.get("notifier");!0===e.value?(t.addClass("ui-bizagi-wp-project-activity-shared").unbind("click"),i.showSucessMessage(bizagi.localization.getResource("workportal-project-activity-success-message"),"")):i.showErrorMessage(bizagi.localization.getResource("workportal-project-activity-error-message"),"")}).always(function(){t.attr("disabled",!1)})},calculateDataForTemplate:function(e,t,i,s,a,o){new Date(Date.now()-i.getTime());var r=s.getTime()-a.getTime(),n=i.getTime()-a.getTime(),c=(bizagi.currentUser.idUser,i.getTime()),u=Date.now(),p=!1,l={idUser:bizagi.currentUser.idUser,fromDate:s.getTime(),toDate:a.getTime()},d={};r>0?(l.fromDate=a.getTime(),l.toDate=s.getTime(),p=!0):(d.idUser=bizagi.currentUser.idUser,d.fromDate=i.getTime(),d.toDate=a.getTime());var g=u-c,m=l.toDate-l.fromDate,h=r>0?0:d.toDate-d.fromDate,f=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-g),null,!1);if(t.colorState=e.colorState,t.relativeTimeState=bizagi.localization.getResource("workportal-project-activity-state-opened").replace("%s",f),t.percentCompleteBar=100,0===n)t.showEstimatedSolutionDate=!1;else if(t.showEstimatedSolutionDate=!0,!1===p){var b=this.getPercentBar(h/1e3/60,m/1e3/60);t.percentCompleteBar=b.percent}e&&(t.isEvent=bizagi.util.parseBoolean(e.isEvent),t.canShareActivity=e.canShareActivity,t.isShared=e.isShared),t.estimatedSolutionDateFormat=this.getFormattedDate(a),this.updateTemplateWidget(t,o)},getPercentBar:function(e,t){var i={};return i.percent=Math.round(100*(1-t/e)),i},updateTemplateWidget:function(e,t){var i=this.getContent().empty();!1===bizagi.override.enableShareActivity&&(e.canShareActivity=!1,e.isShared=!1),this.getTemplate("project-activityState-wrapper").render(e).appendTo(i),t.length>0&&this.initilizeActionMenu(t),this.shareActivityTooltip()},shareActivityTooltip:function(){var e=$("#ui-bizagi-wp-project-activity-button",this.content);e.on("mouseenter",function(){var t=e.hasClass("ui-bizagi-wp-project-activity-shared")?"workportal-project-activity-shared":"workportal-project-activity-share";e.attr("title",bizagi.localization.getResource(t))}),e.tooltip({tooltipClass:"custom-tooltip-styling-bottom-bar",position:{my:"right top",at:"left top",of:e,collision:"flip"}})},getFormattedDate:function(e){var t=this.datePickerRegional.monthNames,i=e.getMonth(),s=BIZAGI_LANGUAGE;return null!=s&&null!=s&&s.length>0&&"fr"==s.substring(0,2)?$.datepicker.formatDate("dd",e)+" "+t[i]:t[i]+" "+$.datepicker.formatDate("dd",e)},clean:function(){var e=this,t=e.contextsSidebarActivity||[];this.params={},t.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})},callGetEffectiveDuration:function(e){var t=this,i=$.Deferred();return setTimeout(function(){e.fromDate?$.when(t.dataService.getEffectiveDuration(e)).done(function(e){i.resolve(e)}):i.resolve(null)},200),i.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.activityState",["workportalFacade","dataService",bizagi.workportal.widgets.project.activityState]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.processState",{},{init:function(e,t,i){this._super(e,t,i),this.contextsSidebarActivity=i.contextsSidebarActivity,this.loadTemplates({"project-process-state":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.processState").concat("#project-process-state")})},renderContent:function(){var e=this.getTemplate("project-process-state");return this.content=e.render({}),this.content},postRender:function(){var e=this;e.contextsSidebarActivity.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var i=this,s=t.args,a=i.getContent().empty();i.params=s;var o={};o.showParentProcess=s.idParentCase>=1,o.parentProcess={displayName:s.parentDisplayName,idCase:s.idParentCase,idWorkItem:s.idWorkItem,idTask:"0"==s.idTask?"":s.idTask,idWorkflow:s.idWorkflowParentCase},i.getTemplate("project-process-state").render($.extend(s,o)).appendTo(a),$("#go-to-parent-case",a).on("click",$.proxy(i.onClickGoToParentCase,i))},onClickGoToParentCase:function(e){e.preventDefault();this.routingExecute($(e.target).closest("#go-to-parent-case"))},clean:function(){var e=this;e.params={},e.contextsSidebarActivity.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})}}),bizagi.injector.register("bizagi.workportal.widgets.project.processState",["workportalFacade","dataService",bizagi.workportal.widgets.project.processState]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.users",{},{init:function(e,t,i,s){var a=this;a.relatedusers=i,a._super(e,t,s),a.contextsSidebarActivity=s.contextsSidebarActivity,a.plugins={},a.users=[],a.loadedUsers=!1,a.loadTemplates({"project-users":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.users").concat("#project-users-main")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.contextsSidebarActivity.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))}),e.sub("ON_RENDER_FINISH",$.proxy(e.onRenderFinish,e))},updateView:function(e,t){var i=this;i.params=t,setTimeout(function(){!1===i.loadedUsers&&i.onRenderFinish()},500)},onRenderFinish:function(){var e=this,t=e.params.args,i=e.getContent().empty();e.loadedUsers=!0,e.getTemplate("project-users").render().appendTo(i),e.showCreatorInformation(i);var s=[{id:t.createdBy.userId,typeName:"owner"}];t.idCase>0&&e.relatedusers.render(e.content,".relatedusers-wrapper",t.idCase,s)},showCreatorInformation:function(e){var t=this,i={userIds:t.params.args.createdBy.userId,width:50,height:50};t.dataService.getUsersData(i).done(function(i){var s=usersAdapter.createJsonUserInfo(i[0].id,i[0].name,i[0].username,i[0].picture?"data:image/png;base64,"+i[0].picture:void 0,i[0].email,i[0].name.getInitials(),!1,!0,[],[]);e.find("#ui-bizagi-wp-project-users-wrapper .ui-bizagi-wp-project-users-creator-info").userinformation(t,{user:s})})},clean:function(){var e=this;e.loadedUsers=!1,e.contextsSidebarActivity.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})}}),bizagi.injector.register("bizagi.workportal.widgets.project.users",["workportalFacade","dataService","relatedusers",bizagi.workportal.widgets.project.users]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.subprocesses.data",{responseSubprocessState:{},responseSubprocess:function(e){return e&&(responseSubprocessState=e),responseSubprocessState},auxArrayListSubprocessesState:[],auxArrayListSubprocesses:function(e){return e?jQuery.isArray(e)&&0===e.length?void(this.auxArrayListSubprocessesState.length=0):this.auxArrayListSubprocessesState.push(e):this.auxArrayListSubprocessesState}},{init:function(e,t,i){this._super(e,t,i),this.Class.auxArrayListSubprocesses([]),this.loadTemplates({"project-subprocesses-tootip-custom-properties":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.subprocesses.data").concat("#project-subprocesses-tooltip-custom-properties-wrapper")})},initializeTooltip:function(e){var t=this,i=t.getContent();$(e,i).tooltip({position:{collision:"flipfit",my:"right center",at:"left-10 center"},show:null,content:function(){var e,i,s,a=$(this).closest("li").find("#idCase").val(),o=t.Class.auxArrayListSubprocesses().filter(function(e){return e.idCase==a});if(o.length>0)return e=o[0].indexSubprocess,i=o[0].idCustData,s=$(this).text(),t.getContentTooltip(e,i,s,t.getTemplate("project-subprocesses-tootip-custom-properties"))},open:function(e,t){if(void 0===e.originalEvent)return!1;var i=$(t.tooltip).attr("id");$("div.ui-tooltip").not("#"+i).remove()},close:function(e,t){t.tooltip.hover(function(){$(this).stop(!0).fadeTo(400,1)},function(){$(this).fadeOut("400",function(){$(this).remove()})})}})},getContentTooltip:function(e,t,i,s){"-1"==t&&(t="0");var a=function(e,t){return{nameProperty:e,valueProperty:t}},o=[],r="",n=this.getSubprocessData(e,t),c=n.custData,u=n.custDataTypes,p=n.custFields,l=n.displayName;if(o.push(new a(bizagi.localization.getResource("workportal-widget-inboxcommon-subprocess"),l)),c.length)for(var d=0;d<c.length;d+=1)r=c[d],u&&("Money"==u[d]?r=bizagi.util.formatMonetaryCell(r):"Boolean"==u[d]?r=bizagi.util.formatBoolean(r):"Float"==u[d]||"Real"==u[d]?r=bizagi.util.formatDecimalCell(r):"function"==typeof r&&(r="")),o.push(new a(p[d],r));var g={};g.arrayCustomsProperties=o,g.nameSubprocess=i;var m=s,h=$('<div class="bizagi-custom-tooltip-subprocesses"></div>');return m.render(g).appendTo(h),h.html()},getSubprocessData:function(e,t){var i={},s=this.Class.responseSubprocess().subProcesses,a=this.Class.responseSubprocess().subProcPersonalized;if(s&&s.length>0){i.custData=s[e].custData,i.custDataTypes=s[e].custDataTypes;var o=this.Class.responseSubprocess().CustFields[t];i.custFields=o[Object.keys(o)[0]],i.displayName=s[e].displayName}else a&&Object.keys(a).length>0&&(i.custData=a[0].subProcesses[e].custData,i.custDataTypes=a[0].subProcesses[e].custDataTypes,i.custFields=a[0].CustFields[0],i.displayName=a[0].subProcesses[e].displayName);return i},clean:function(){}}),bizagi.injector.register("bizagi.workportal.widgets.project.subprocesses.data",["workportalFacade","dataService",bizagi.workportal.widgets.project.subprocesses.data]),bizagi.workportal.widgets.project.subprocesses.data.extend("bizagi.workportal.widgets.project.events",{},{init:function(e,t,i){this._super(e,t,i),this.contextsSidebarActivity=i.contextsSidebarActivity,this.loadTemplates({"project-events":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.events").concat("#project-events-wrapper")})},renderContent:function(){var e=this.getTemplate("project-events");return this.content=e.render({}),this.content},postRender:function(){var e=this;e.contextsSidebarActivity.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var i=this,s=t.args,a=i.getContent().empty();i.params=s,$.when(i.getArgsTemplate(s)).done(function(e){i.getTemplate("project-events").render($.extend(s,e)).appendTo(a),$(".list-events li.event a",a).on("click",$.proxy(i.onClickGoEvent,i)),i.initializeTooltip(".list-events li")})},getArgsTemplate:function(e){var t=$.Deferred(),i={};if(e.countEvents>=1)for(var s=0;s<e.currentState.length;s++)"true"==e.currentState[s].isEvent&&e.currentState[s].idWorkItem==e.idWorkitem&&(e.countEvents=e.countEvents-1);return i.showEvents=e.countEvents>=1,i.showEvents?$.when(this.callSummaryCaseEvents(e.idCase)).done(function(s){e.showEvents=s.events.length>=1,e.showEvents&&(i.events=[],s.events.forEach(function(e){i.events.push($.extend(e[Object.keys(e)[0]],{idWorkFlow:s.idWorkFlow}))})),t.resolve(i)}):t.resolve(i),t.promise()},onClickGoEvent:function(e){e.preventDefault();var t=this;$.when(bizagi.util.autoSave()).done(function(){t.routingExecute($(e.target).closest("li"))})},callSummaryCaseEvents:function(e){var t=$.Deferred();return $.when(this.dataService.summaryCaseEvents({idCase:e})).done(function(e){t.resolve(e)}),t.promise()},clean:function(){var e=this;this.params={},e.contextsSidebarActivity.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})}}),bizagi.injector.register("bizagi.workportal.widgets.project.events",["workportalFacade","dataService",bizagi.workportal.widgets.project.events],!0),bizagi.workportal.widgets.project.subprocesses.data.extend("bizagi.workportal.widgets.project.subprocesses",{responseSubprocess:function(e){return this._super(e)},auxArrayListSubprocesses:function(e){return this._super(e)}},{init:function(e,t,i){this._super(e,t,i),this.contextsSidebarActivity=i.contextsSidebarActivity,this.loadTemplates({"project-subprocesses":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.subprocesses").concat("#project-subprocesses-wrapper")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.contextsSidebarActivity.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var i=this,s=t.args;i.getContent().empty();i.params=s,i.params.idCase>0&&$.when(i.dataService.summarySubProcess({idCase:i.params.idCase})).done(function(e){i.Class.responseSubprocess(e),i.organizeDataForSubprocesses(i.params)})},organizeDataForSubprocesses:function(e){var t=this;if(t.Class.responseSubprocess().showSubProcess){$.each(t.Class.responseSubprocess().subProcesses,function(e){var i=t.Class.responseSubprocess().subProcesses[e].custData;if(i&&i.length)for(var s=0;s<i.length;s+=1)null===i[s]&&(i[s]="")});var i=t.Class.responseSubprocess().subProcesses||t.Class.responseSubprocess().subProcPersonalized;t.Class.auxArrayListSubprocesses([]);for(var s=0;s<Object.keys(i).length;s+=1){var a=i[s];t.Class.auxArrayListSubprocesses({isOpen:a.isOpen,radNumber:a.radNumber,displayName:a.displayName,idCase:a.idCase,indexSubprocess:s,idCustData:a.idCustData}),a.subProcesses&&Object.keys(a).forEach(function(e){t.Class.auxArrayListSubprocesses({isOpen:a[e].isOpen,radNumber:a[e].radNumber,displayName:a[e].displayName,idCase:a[e].idCase,indexSubprocess:s,idCustData:a[e].idCustData})})}t.renderWidget()}},renderWidget:function(){var e=this,t=e.getContent();e.getTemplate("project-subprocesses").render({auxArrayListSubprocesses:e.Class.auxArrayListSubprocesses()}).appendTo(t),$(".list-subprocesses a",t).on("click",$.proxy(e.onClickGoSubprocess,e)),e.initializeTooltip(".list-subprocesses li")},onClickGoSubprocess:function(e){e.preventDefault();this.routingExecute($(e.target).closest("li"))},clean:function(){var e=this;e.params={},e.pluginTooltip=null,e.contextsSidebarActivity.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))})}}),bizagi.injector.register("bizagi.workportal.widgets.project.subprocesses",["workportalFacade","dataService",bizagi.workportal.widgets.project.subprocesses]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.activity.description",{},{init:function(e,t,i){this._super(e,t,i),i=i||{},this.loadTemplates({"project-activity-description":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.activity.description").concat("#project-activity-description")})},renderContent:function(){var e=this,t=e.getTemplate("project-activity-description"),i=e.getWorkitemDescription();return e.content=i?t.render({description:i}):$("<div />"),e.content},postRender:function(){},getWorkitemDescription:function(){for(var e=this.params||{},t=e.idWorkitem||0,i=e.currentState||[],s="",a=0;a<i.length;a++)if(t==i[a].idWorkItem){s=i[a].tskDescription;break}return s},clean:function(){}}),bizagi.injector.register("bizagi.workportal.widgets.project.activity.description",["workportalFacade","dataService",bizagi.workportal.widgets.project.activity.description],!0);
//# sourceMappingURL=../../../../Maps/desktop/comments.desktop.production.js.map
