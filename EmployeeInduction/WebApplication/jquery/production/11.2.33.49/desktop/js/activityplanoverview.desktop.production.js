bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.sidebar",{},{init:function(e,t,a,i){var n=this;n._super(e,t,i),n.serviceloadDataPlan=a,n.loadTemplates({"project-plan-activity-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.sidebar").concat("#project-plan-activity-sidebar")})},renderContent:function(){var e=this,t=e.getTemplate("project-plan-activity-sidebar");return e.content=t.render({}),e.content},postRender:function(){var e=this;e.sub("LOAD_INFO_PLAN",$.proxy(e.onNotifyLoadInfoPlan,e))},onNotifyLoadInfoPlan:function(e,t){var a=this;if(a.params.plan.idActivitySelected){var i={idPlan:a.params.plan.id};a.serviceloadDataPlan.loadData(i,a.getDateServer,a.params),a.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(a.loadedWithDataActivities,a)),a.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(a.loadedWithDataFirstParent,a))}else"ACTIVITYPLANPROCESSMAP"!==a.params.showContextByMenuDashboard&&"ACTIVITYPLANLOG"!==a.params.showContextByMenuDashboard||a.pub("notify",{type:"DISABLED_RIGHT_SIDEBAR"})},loadedWithDataActivities:function(){var e=this;e.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_ACTIVITY_SUMMARY",args:e.params}),e.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:e.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){var e=this;e.serviceloadDataPlan&&(e.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(e.loadedWithDataActivities,e)),e.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(e.loadedWithDataFirstParent,e)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.activity.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activity.action",{},{init:function(e,t,a,i){var n=this;n._super(e,t,i),n.dateFormat=bizagi.localization.getResource("dateFormat"),n.timeFormat=bizagi.localization.getResource("timeFormat"),n.estimatedFinishDateTime,n.beforeUserAssignedActivity="",n.notifier=a,n.loadTemplates({"activity-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action"),"activity-action-editionpopup":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.action").concat("#project-plan-activity-action-editionpopup")}),n.dialogBox={}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(e.onNotifyLoadInfoActivityExecution,e)),e.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))},onNotifyLoadInfoActivityExecution:function(e,t){var a=this;a.params=$.extend(a.params,t.args);var i=a.getContent().empty(),n={};if(a.params.plan.idActivitySelected&&(n=a.params.plan.activities.filter(function(e){return e.id.toUpperCase()===a.params.plan.idActivitySelected.toUpperCase()})[0]),a.params.plan.idUserCreator===bizagi.currentUser.idUser||n.userAssigned==bizagi.currentUser.idUser){var r={};r.currentActivityName=n.name,r.showEditAction=!0,a.params.plan.idUserCreator!==bizagi.currentUser.idUser&&(r.showEditAction=!1);var o=a.getTemplate("activity-action-main");i.append(o.render(r)),r.showEditAction&&(a.initilizeActionMenu(),a.beforeUserAssignedActivity=n.userAssigned,a.content.append(i),a.initializeTempleteAndEvents())}},initializeTempleteAndEvents:function(){var e=this;e.plugins={},e.plugins.activityEdition=e.initPluginPopupEdition(),e.formEditActivity={assignee:$("#activity-form-assignee",e.plugins.activityEdition),date:$("#activity-form-date",e.plugins.activityEdition),duration:$("#activity-form-duration",e.plugins.activityEdition),buttonCancel:$("#ui-bizagi-wp-project-popupform-action-cancel",e.plugins.activityEdition),buttonUpdate:$("#ui-bizagi-wp-project-popupform-action-update",e.plugins.activityEdition)},e.formEditActivity.buttonCancel.on("click",$.proxy(e.onClickPopupButtonCancel,e)),e.formEditActivity.buttonUpdate.on("click",$.proxy(e.onClickPopupButtonUpdate,e)),e.formEditActivity.date.on("keydown",$.proxy(e.onDeleteDate,e)),e.formEditActivity.duration.on("keyup",$.proxy(e.onTypeDuration,e))},onNotifyExpandedRightSidebar:function(){this.initilizeActionMenu()},initilizeActionMenu:function(){var e=this;$("#ui-bizagi-wp-project-plan-activity-action .menu",e.content).menu({select:$.proxy(e.onSelectMenu,e)}).removeClass("ui-widget-content")},initPluginPopupEdition:function(){var e=this,t=e.getTemplate("activity-action-editionpopup");return e.dialogBox.formContent=t.render({}),e.dialogBox.formContent},initializeAutoComplete:function(e){var t=this,a=t.dataService.serviceLocator.getUrl("admin-getUsersList");e.autocomplete({minLength:2,source:function(e,t){$.ajax({url:a,data:{domain:"",userName:"",fullName:e.term,organization:"",pag:1,pagSize:100,orderField:"fullName"},success:function(e){t($.map(e.users,function(e){return{label:e.user,value:e.idUser}}))}})},select:function(a,i){var n=i.item.label;return e.val(n),t.formEditActivity.IdAssignee=i.item.value,!1},focus:function(){return!1},change:function(e,a){return null===a.item&&(t.formEditActivity.IdAssignee=null,t.formEditActivity.assignee.val("")),!1}})},initializeDatePicker:function(e){var t=this;e.datepicker({onSelect:function(){t.formEditActivity.duration.val(""),t.estimatedFinishDateTime=t.formEditActivity.date.datepicker("getDate")?t.formEditActivity.date.datepicker("getDate").getTime():void 0}}),e.datepicker("option","dateFormat",bizagi.util.dateFormatter.getDateFormatByDatePickerJqueryUI())},initializeSpiner:function(e){var t=this;function a(e,a){var i=a||$(e.target).val();bizagi.util.isNumeric(i)&&parseInt(i,10)>0?(t.formEditActivity.date.val(""),t.estimatedFinishDateTime=void 0):$(e.target).val("")}e.spinner({min:1,max:1e3,placeHolder:bizagi.localization.getResource("workportal-hours"),change:function(e){a(e)},spin:function(e,t){a(e,t.value)}})},onDeleteDate:function(e){8===e.keyCode&&($(e.target).val(""),this.fieldDurationActive(!0))},onTypeDuration:function(e){""!==$(e.target).val()?this.estimatedFinishDateTime=void 0:this.activateElement(this.form.date)},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"edit":this.onClickOpenPopupEdition()}},onClickOpenPopupEdition:function(){var e=this;e.initializeTempleteAndEvents(),e.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-title-activity-properties"),maximize:!0,open:$.proxy(e.onOpenPopupEdition,e),close:$.proxy(e.onClosePopupEdition,e)})},onOpenPopupEdition:function(){var e=this,t=e.params.plan.activities.filter(function(t){return t.id.toUpperCase()===e.params.plan.idActivitySelected.toUpperCase()})[0],a=t&&!bizagi.util.isEmpty(t.estimatedFinishDate)?t.estimatedFinishDate:"";isNaN(a)||(a=bizagi.util.dateFormatter.formatInvariant(new Date(a)));var i=a?bizagi.util.dateFormatter.getDateFromInvariant(a):"",n=i instanceof Date&&i.getTime()<e.getDateServer();e.initializeAutoComplete(e.formEditActivity.assignee),e.initializeDatePicker(e.formEditActivity.date),e.initializeSpiner(e.formEditActivity.duration),t.userAssigned&&e.setUserAssignedById(t.userAssigned),e.formEditActivity.date.datepicker("option","minDate",new Date(e.getDateServer())),t.estimatedFinishDate&&n&&e.formEditActivity.date.datepicker("option","minDate",i),t.estimatedFinishDate&&(i&&e.formEditActivity.date.datepicker("setDate",i),e.estimatedFinishDateTime=t.estimatedFinishDate),t.duration&&e.formEditActivity.duration.val(parseInt(t.duration,10))},onClosePopupEdition:function(){this.removePopupWidgets()},setUserAssignedById:function(e){var t=this;t.callGetDataUsers(e).then(function(e){t.formEditActivity.assignee.val(e[0].name)}),t.formEditActivity.IdAssignee=e},onClickPopupButtonCancel:function(e){e.preventDefault(),this.removePopupWidgets()},removePopupWidgets:function(){this.formEditActivity.assignee.next().find("span").html(""),this.dialogBox.formContent.remove(),$("#ui-datepicker-div").remove()},onClickPopupButtonUpdate:function(){var e=this;if(e.validateParamsOfFormEditActivity()){var t=e.params.plan.activities.filter(function(t){return t.id.toUpperCase()===e.params.plan.idActivitySelected.toUpperCase()})[0],a=e.formEditActivity.IdAssignee||bizagi.currentUser.idUser;""!=e.formEditActivity.duration.val()&&(e.params.plan.activities.filter(function(t){return t.id.toUpperCase()===e.params.plan.idActivitySelected.toUpperCase()})[0].estimatedFinishDate="");var i={progress:t.progress,id:t.id,startDate:t.startDate,duration:e.formEditActivity.duration.val(),userAssigned:a,allowEdition:t.allowEdition,description:t.description,name:t.name,idPlan:t.idPlan,estimatedFinishDate:e.estimatedFinishDateTime,finishDate:t.finishDate,items:t.items};$.when(e.dataService.editActivityPlan(i)).done(function(){t=$.extend(t,i),e.removePopupWidgets(),e.beforeUserAssignedActivity!==e.formEditActivity.IdAssignee?e.pub("notify",{type:"ACTIVITYPLANCOMMENTS",args:$.extend(e.params,{refreshAllWidgets:!0})}):e.pub("notify",{type:e.params.showContextByMenuDashboard,args:e.params}),e.removePopupWidgets(),e.notifier.showSucessMessage(bizagi.localization.getResource("workportal-project-plan-activity-update-message"))})}},onClickFavorite:function(e){e.preventDefault();var t=this,a={};$(e.target).hasClass("bz-icon-star-outline")?(a={idObject:t.params.idCase,favoriteType:"CASES"},$.when(t.dataService.addFavorite(a)).done(function(a){t.params.guidFavorite=a.idFavorites,$(e.target).removeClass("bz-icon-star-outline"),$(e.target).addClass("bz-icon-star")})):(a={idObject:t.params.guidFavorite,favoriteType:"CASES"},$.when(t.dataService.delFavorite(a)).done(function(){$(e.target).addClass("bz-icon-star-outline"),$(e.target).removeClass("bz-icon-star")}))},clean:function(){var e=this;e.unsub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(e.onNotifyLoadInfoActivityExecution,e)),e.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))},validateParamsOfFormEditActivity:function(){var e=this.formEditActivity.assignee;if(e.val()&&""!==e.val()&&this.formEditActivity.IdAssignee)return!0;var t=bizagi.localization.getResource("workportal-general-error-field-required");return t=t.replace("{0}",bizagi.localization.getResource("workportal-project-plan-assignee").toLowerCase()),e.next().find("span").html(t),!1},callGetDataUsers:function(e){var t=$.Deferred(),a={userIds:e,width:50,height:50};return this.dataService.getUsersData(a).always(function(e){t.resolve(e)}),t.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.action",["workportalFacade","dataService","notifier",bizagi.workportal.widgets.project.plan.activity.action]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.time",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.EXECUTING_ACTIVITY="EXECUTING",i.FINISHED_ACTIVITY="FINISHED",i.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),i.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.time").concat("#project-plan-activity-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivitySummary,this))},onNotifyLoadInfoActivitySummary:function(e,t){var a=this;a.params=$.extend(a.params,t.args),a.getContent().empty();var i=a.params.plan.activities.filter(function(e){return e.id===a.params.plan.idActivitySelected})[0];if(i.startDate){a.getStateActivity(i);var n={time:{fromDate:a.getFormattedDate(new Date(a.getFirstDate(i)))}},r=a.getDataByScenarios(i,!0);$.when(r.unitTime).done(function(e){r=$.extend(r,{unitTime:e}),a.updateWidget($.extend(n.time,r))})}},updateWidget:function(e){var t=this.getContent().empty(),a=this.getTemplate("plan-time-main"),i=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e.unitTime.minutes*1e3),null,!1),n=bizagi.localization.getResource("workportal-project-activity-state-"+e.keywordResource);e.messageTime=n.replace("%s",i),a.render(e).appendTo(t);var r=$(".remaining-days .time-remaining",t),o=$(".remaining-days .days",t).width();r.css("padding-left",(o+7).toString()+"px"),$(".remaining-days .bar-completed",t).css("width",e.percentBar+"%")},getStateActivity:function(e){return e.finishDate?(e.currentState=this.FINISHED_ACTIVITY,this.FINISHED_ACTIVITY):(e.currentState=this.EXECUTING_ACTIVITY,this.EXECUTING_ACTIVITY)},getFirstDate:function(e){return e.currentState===this.EXECUTING_ACTIVITY?e.startDate:e.finishDate},getDataByScenarios:function(e){var t=this,a={colorBar:null,percentBar:100,keywordResource:null,unitTime:null},i={};switch(e.currentState){case t.EXECUTING_ACTIVITY:a.keywordResource="opened",a.colorBar=t.getColorByCreatedAndEstimatedDate(e),i={idUser:bizagi.currentUser.idUser,fromDate:e.startDate,toDate:Date.now()},a.unitTime=t.callGetEffectiveDuration(i);break;case t.FINISHED_ACTIVITY:a.colorBar="Gray",a.keywordResource="closed",i={idUser:bizagi.currentUser.idUser,fromDate:e.finishDate,toDate:Date.now()},a.unitTime=t.callGetEffectiveDuration(i)}return a},getColorBar:function(e){return this.getDataByScenarios(e).colorBar},getPercentBar:function(e){return this.getDataByScenarios(e).percentBar},getKeywordResourceDescriptionBar:function(e){return this.getDataByScenarios(e).keywordResource},getUnitTime:function(e){return this.getDataByScenarios(e).unitTime},getColorByCreatedAndEstimatedDate:function(e){var t="Red";e.estimatedFinishDate&&(Date.now()<e.estimatedFinishDate&&(t=(new Date).getUTCDate()===new Date(e.estimatedFinishDate).getUTCDate()?"Yellow":"Green"));return t},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))},callGetEffectiveDuration:function(e){var t=$.Deferred();return $.when(this.dataService.getEffectiveDuration(e)).done(function(e){t.resolve(e)}),t.promise()}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.progress",{},{init:function(e,t,a){this._super(e,t,a),this.plugins={},this.dialogBox={},this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-progress"),"plan-progress-popup-edit":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.progress").concat("#project-plan-activity-edit-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(e.onNotifyLoadInfoActivityExecution,e)),e.sub("UPDATE_ITEMS_FROM_FORMRENDER",$.proxy(e.onNotifyUpdateItemFromRender,e))},onNotifyLoadInfoActivityExecution:function(e,t){var a=this;a.params=$.extend(a.params,t.args);var i=a.getContent().empty(),n=a.params.plan.activities.filter(function(e){return e.id.toUpperCase()==a.params.plan.idActivitySelected.toUpperCase()})[0],r={valuePercentBarComplete:0};r.progress={progress:n.progress,canEdit:0===n.items.length},r.progress.progress&&(r.valuePercentBarComplete=r.progress.progress),a.getTemplate("plan-progress-main").render(r).appendTo(i),a.plugins.popupEditProgress=a.initPluginPopupEditProgress();var o=a.plugins.popupEditProgress;a.formEditProgress={sliderProgress:$("#sliderProgress",o).slider({orientation:"horizontal",range:"min",max:100,width:100,from:5,to:50,step:1,value:r.valuePercentBarComplete,slide:$.proxy(a.onChangesliderProgress,a),change:$.proxy(a.onChangesliderProgress,a)}).each(function(){for(var e=$(this).slider("option","max")-$(this).slider("option","min"),t=0;t<=e;t+=10){var a=$("<label class='step'>"+t+"</label>").css("left",t/e*100+"%");$(this).append(a)}}),numericTextBoxPlugin:$("#inputProgressNumericTextBox",o).spinner({format:"n0",min:0,max:100,spin:$.proxy(a.onChangeNumericTextBoxProgress,a),change:$.proxy(a.onChangeNumericTextBoxProgress,a),value:r.valuePercentBarComplete,decimals:0}),buttonChangeProgress:$("#button-accept-change-progress",o),buttonCancel:$("#button-cancel-change-progress",o)},$(".action-open-popup-edit-progress",i).on("click",$.proxy(a.onShowPopupEditProgress,a)),a.formEditProgress.buttonCancel.on("click",$.proxy(a.onClickCancel,a)),a.formEditProgress.buttonChangeProgress.on("click",$.proxy(a.onSubmitFormChangeProgress,a)),a.updateProgressUI(r.valuePercentBarComplete),a.formEditProgress.numericTextBoxPlugin.spinner("value",r.valuePercentBarComplete)},onNotifyUpdateItemFromRender:function(e,t){var a=t.args.items,i=t.args.activityWork;a.length>0?$(".action-open-popup-edit-progress",this.content).hide():$(".action-open-popup-edit-progress",this.content).show(),$(".bz-wp-timestamp span",this.content).text(i),$(".bz-wp-progress-bar",this.content).css("width",i+"%")},updateProgressUI:function(e){var t=this.getContent();$(".bz-wp-timestamp span",t).text(e);var a=$(".remaining-days .time-remaining",t),i=$(".remaining-days .days",t).width();a.css("padding-left",(i+7).toString()+"px"),$(".remaining-days .bar-completed",t).css("width",e.toString()+"%")},initPluginPopupEditProgress:function(){var e=this.getTemplate("plan-progress-popup-edit");return this.dialogBox.formContent=e.render(),this.dialogBox.formContent},onShowPopupEditProgress:function(){var e=this;e.dialogBox.formContent.dialog({resizable:!1,draggable:!1,height:"auto",width:"600px",modal:!0,title:bizagi.localization.getResource("workportal-project-plan-progress-title"),maximize:!0,open:$.proxy(e.onOpenPopupPlan,e),close:function(){e.dialogBox.formContent.dialog("destroy"),e.dialogBox.formContent.detach()}}),e.previusValueProgress=e.formEditProgress.sliderProgress.slider("value")},onChangeNumericTextBoxProgress:function(e){var t=this.formEditProgress.numericTextBoxPlugin.spinner("value");this.formEditProgress.sliderProgress.slider("value",t)},onChangesliderProgress:function(e){var t=this.formEditProgress.sliderProgress.slider("value");this.formEditProgress.numericTextBoxPlugin.spinner("value",t)},onClickCancel:function(e){e.preventDefault();var t=this;t.dialogBox.formContent.dialog("destroy"),t.dialogBox.formContent.detach(),t.formEditProgress.sliderProgress.slider("value",t.previusValueProgress),t.formEditProgress.numericTextBoxPlugin.spinner("value",t.previusValueProgress)},onSubmitFormChangeProgress:function(e){e.preventDefault();var t=this;t.formEditProgress.buttonChangeProgress.prop("disabled",!0);var a=t.params.plan.activities.filter(function(e){return e.id==t.params.plan.idActivitySelected})[0],i=$.extend(a,{progress:t.formEditProgress.numericTextBoxPlugin.spinner("value"),idPlan:t.params.plan.id});$.when(t.dataService.editActivityPlan(i)).done(function(){t.formEditProgress.buttonChangeProgress.prop("disabled",!1),a.progress=t.formEditProgress.numericTextBoxPlugin.spinner("value"),t.updateProgressUI(a.progress),t.dialogBox.formContent.dialog("destroy"),t.dialogBox.formContent.detach()})}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.subprocesses",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"project-subprocesses":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-plan-activity-plan-subprocesses-wrapper"),"project-subprocesses-tootip-custom-properties":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.subprocesses").concat("#project-activity-plan-subprocesses-tooltip-custom-properties-wrapper")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.subprocesses",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.subprocesses]),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.activity.parent",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.activity.parent").concat("#project-plan-activity-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITY_SUMMARY",$.proxy(this.onNotifyLoadInfoActivityExecution,this))},onNotifyLoadInfoActivityExecution:function(e,t){var a=this;a.params=$.extend(a.params,t.args);var i=a.getContent().empty();$.when(a.dataService.getPlanParent({idPlan:a.params.plan.id})).done(function(e){if(a.params.plan.parent=e,a.params.plan.parent){var t={};t.parent={idParent:a.params.plan.parent.radNumber,nameParent:a.params.plan.parent.displayName,idCase:a.params.plan.parent.idCase,idWorkflow:a.params.plan.parent.idWorkflow,idWorkItem:a.params.plan.parent.idWorkItem,idTask:a.params.plan.parent.idTask},a.getTemplate("plan-parent-main").render(t).appendTo(i),$("#go-to-parent-case",i).on("click",$.proxy(a.onClickGoToParentCase,a))}})},onClickGoToParentCase:function(e){e.preventDefault();this.routingExecute($(e.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activity.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.activity.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.activity",{},{init:function(e,t,a){this.params=a||{},this._super(e,t,a),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity").concat("#project-dashboard-menu1")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var a=this;a.params=$.extend(a.params,t.args),a.params.plan.idActivitySelected=void 0,a.clean();var i=a.getContent().empty();void 0!==e.type&&(a.params.showContextByMenuDashboard=e.type);var n={showFormOverview:a.params.menuDashboard.showFormOverview,showFormActivity:a.params.menuDashboard.showFormActivity,showCommentsOptionMenu:a.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:a.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:a.params.menuDashboard.showTimeLineOptionMenu&&(!a.params.isAdhocProcess||a.params.isAdhocProcess&&bizagi.util.isEnableFeature("enableTimelineOnLiveProcesses")),showPlanOptionMenu:a.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:a.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:a.params.menuDashboard.contextFormActivityOptionMenu};a.getTemplate("project-dashboard-menu").render(n).appendTo(i),a.params.showContextByMenuDashboard&&$("li[data-context='"+a.params.showContextByMenuDashboard.toUpperCase()+"']",a.content).addClass("active").siblings().removeClass("active"),a.handlerEvents()},loadContentById:function(e){var t=this;e.preventDefault();var a=$(e.target).closest("li");if(!a.hasClass("active")){var i=a.data("context");i&&$.when(bizagi.util.autoSave()).done(function(){$(document).data("auto-save","");var e=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),a=parseInt(e[0],10),n="",r=a;"PLANACTIVITIES"==i&&(r=a+1,n=bizagi.localization.getResource("workportal-project-casedashboard-plan")),t.params.refreshLastItemBreadcrumb=!1,t.pub("notify",{type:i.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:i,histName:n,level:r})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")})}},subMenuHandler:function(){var e=this.getContent(),t=$("[data-context='COMMENTS']",e),a=$("[data-context='FILES']",e),i=$("[data-context='TIMELINE']",e);$(".ui-bizagi-wp-project-tab-submenu a",e).on("click",function(){t.toggle(),a.toggle(),i.toggle()})},handlerEvents:function(){var e=this,t=e.getContent();e.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",t).on("click",$.proxy(e.loadContentById,e)),$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",t).on("click",function(){var t={action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:e.params.idCase,idTask:e.params.idTask,idWorkflow:e.params.idWorkflow,idWorkItem:e.params.idWorkitem,referrer:e.params.referrer||"inboxGrid"};e.publish("executeAction",t)})},clean:function(){var e=this,t=e.getContent();e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))}),$(".ui-bizagi-wp-project-tab-links a",t).off(),$(".ui-bizagi-wp-project-tab-links li .ui-bizagi-refresh-form",t).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",{},{init:function(e,t,a){this.params=a||{},this._super(e,t,a),this.loadTemplates({"project-dashboard-menu":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.dashboard.menu.activity.plan").concat("#project-dashboard-menu2")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.sub(t,$.proxy(e.updateView,e))})},updateView:function(e,t){var a=this;a.params=$.extend(a.params,t.args),a.clean();var i=a.getContent().empty(),n={showFormOverview:a.params.menuDashboard.showFormOverview,showFormActivity:a.params.menuDashboard.showFormActivity,showCommentsOptionMenu:a.params.menuDashboard.showCommentsOptionMenu,showFilesOptionMenu:a.params.menuDashboard.showFilesOptionMenu,showTimeLineOptionMenu:a.params.menuDashboard.showTimeLineOptionMenu,showPlanOptionMenu:a.params.menuDashboard.showPlanOptionMenu,contextPlanOptionMenu:a.params.menuDashboard.contextPlanOptionMenu,contextFormActivityOptionMenu:a.params.menuDashboard.contextFormActivityOptionMenu,contextualized:a.params.plan.contextualized};a.getTemplate("project-dashboard-menu").render(n).appendTo(i),a.params.showContextByMenuDashboard&&$("li[data-context='"+e.type.toUpperCase()+"']",a.content).addClass("active").siblings().removeClass("active"),a.handlerEvents();var r={idPlan:a.params.plan.id};$.when(a.callGetPlan(r)).then(function(e){$.extend(a.params.plan,e),a.pub("notify",{type:"LOAD_INFO_PLAN",args:a.params})})},loadContentById:function(e){var t=this;e.preventDefault();var a=$(e.target).closest("li");a.hasClass("active")||$.when(bizagi.util.autoSave()).done(function(){$(document).data("auto-save","");var e=a.data("context");if(e){var i=t.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),n=parseInt(i[0]);t.params.refreshLastItemBreadcrumb=!1,t.pub("notify",{type:e.toUpperCase(),args:$.extend(t.params,{showContextByMenuDashboard:e,histName:"",level:n})}),$("li[data-context='"+t.params.showContextByMenuDashboard.toUpperCase()+"']",t.content).addClass("active").siblings().removeClass("active")}})},callGetPlan:function(e){var t=$.Deferred();return this.dataService.getPlan(e).always(function(e){200===e.status||201===e.status||void 0===e.status?t.resolve(e):t.reject()}),t.promise()},subMenuHandler:function(){var e=this.getContent(),t=$("[data-context='ACTIVITYPLANCOMMENTS']",e),a=$("[data-context='ACTIVITYPLANFILES']",e),i=$("[data-context='ACTIVITYPLANTIMELINE']",e);$(".ui-bizagi-wp-project-tab-submenu a",e).on("click",function(){t.toggle(),a.toggle(),i.toggle()})},handlerEvents:function(){var e=this.getContent();this.subMenuHandler(),$(".ui-bizagi-wp-project-tab-links a",e).on("click",$.proxy(this.loadContentById,this))},clean:function(){var e=this,t=e.getContent();e.params&&e.params.contextsLeftSidebarCaseDashboard&&e.params.contextsLeftSidebarCaseDashboard.forEach(function(t){e.unsub(t,$.proxy(e.updateView,e))}),$(".ui-bizagi-wp-project-tab-links a",t).off()}}),bizagi.injector.register("bizagi.workportal.widgets.project.dashboard.menu.activity.plan",["workportalFacade","dataService",bizagi.workportal.widgets.project.dashboard.menu.activity.plan],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.content.dashboard",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"project-content-dashboard":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.content.dashboard").concat("#project-plan-content-dashboard")})},renderContent:function(){var e=this.getTemplate("project-content-dashboard");return this.content=e.render({}),this.content},postRender:function(){setTimeout(function(){$(window).trigger("resize")},1e3)}}),bizagi.injector.register("bizagi.workportal.widgets.project.content.dashboard",["workportalFacade","dataService",bizagi.workportal.widgets.project.content.dashboard],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.activities",{},{init:function(e,t,a,i,n){var r=this;r._super(e,t,n),r.serviceOrderActivitiesByTransitions=i,r.PENDING_PLAN="PENDING_PLAN",r.EXECUTING_PLAN="EXECUTING_PLAN",r.CONTEXT_PLANACTIVITIES="PLANACTIVITIES",r.CONTEXT_PLANOVERVIEW="PLANOVERVIEW",r.CONTEXT_PLANCREATE="PLANCREATE",r.plugins={},r.fromIndexEnabledSortingActivities=0,r.idActivityEditing="",r.plugins.notifier=a,r._statePlan=r.PENDING_PLAN,r.userPictures=[],r.refresh=n.refreshAllWidgets,r.loadTemplates({"plan-activities-main":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.activities").concat("#project-plan-activities"),"plan-activities-item":bizagi.getTemplate("bizagi.workportal.desktop.widgets.project.plan.activities").concat("#project-plan-activities-item")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){var e=this;e.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(e.onNotifySummaryProgressPlan,e)),e.sub("UPDATE_INFO_PLAN",$.proxy(e.onNotifyUpdatePlan,e)),e.sub("UPDATE_LIST_ACTIVITIES",$.proxy(e.renderWidgetByStatePlan,e)),e.sub("UPDATE_ACTIVITY_INFO",$.proxy(e.refreshActivityRow,e)),e.refresh||e.collapseSidebars()},onNotifySummaryProgressPlan:function(e,t){var a=this;a.params=$.extend(a.params,t.args);var i=a.params.plan.currentState;a._statePlan=i+"_PLAN",a.renderWidgetByStatePlan(e.type)},renderWidgetByStatePlan:function(e){var t=this;t.idActivityEditing="";var a=t.getContent().empty(),i=t.enableEventsOnActivitiesByCurrentContext(t.params.showContextByMenuDashboard),n=t.params.plan.activities.filter(function(e){return e.finishDate}).length,r={showContextByMenuDashboard:t.params.showContextByMenuDashboard,statePlan:t._statePlan,statePendingPlan:t.PENDING_PLAN,stateExecutingPlan:t.EXECUTING_PLAN,contextPlanActivities:t.CONTEXT_PLANACTIVITIES,plan:t.params.plan,showFormAddActivityByNotFinishedAllActivities:n!==t.params.plan.activities.length,currentUserGuid:bizagi.currentUser.userGuid};t.getTemplate("plan-activities-main").render($.extend(t.params,r)).appendTo(a),t._statePlan!==t.PENDING_PLAN&&t._statePlan!==t.EXECUTING_PLAN||!i||(t.plugins.sortablelist=t.initializeSortableList(),t.addEventHandlers()),t.setContentWrapper(a),$(".project-plan-activity-list",a).on("click","li",$.proxy(t.onClickEditActivity,t)),$(".project-plan-activity-list",a).on("click","li .activity-view",$.proxy(t.onClickEditActivity,t)),$(".project-plan-activity-list",a).on("click","li .bz-icon-trash-outline",$.proxy(t.onClickDeleteActivity,t)),$(".project-plan-activity-list",a).on("click","li .item-workonit-button",$.proxy(t.onClickWorkonItActivity,t)),t.params.showContextByMenuDashboard===t.CONTEXT_PLANACTIVITIES&&$(".project-plan-activity-list",a).on("click","li .ui-bizagi-wrapper-parallel-icon",$.proxy(t.onClickChangeParallel,t)),t._statePlan===t.PENDING_PLAN?$("a#to-execute-plan",a).on("click",$.proxy(t.onExecutePlan,t)):"CLOSED_PLAN"!==t._statePlan&&$("a#to-close-plan",a).on("click",$.proxy(t.onClosePlan,t)),t.renderActivities(),e&&"UPDATE_LIST_ACTIVITIES"===e.type&&t.updateTransitions()},getCopyObjectPlan:function(){var e=this;return{id:e.params.plan.id,name:e.params.plan.name,description:e.params.plan.description,dueDate:e.params.plan.dueDate,waitForCompletion:e.params.plan.waitForCompletion,currentState:e.params.plan.currentState,parentWorkItem:e.params.plan.parentWorkItem,creationDate:e.params.plan.creationDate,startDate:e.params.plan.startDate,idUserCreator:e.params.plan.idUserCreator,contextualized:e.params.plan.contextualized,activities:e.params.plan.activities}},enableEventsOnActivitiesByCurrentContext:function(e){return e===this.CONTEXT_PLANACTIVITIES},onNotifyUpdatePlan:function(){var e=this;e.params.showContextByMenuDashboard===e.CONTEXT_PLANOVERVIEW&&($(".ui-bizagi-wp-project-plan-activities-header h3",e.content).text(e.params.plan.name),$(".ui-bizagi-wp-project-plan-activities-header p",e.content).text(e.params.plan.description))},initializeSortableList:function(){var e=this;return $(".project-plan-activity-list",e.content).kendoSortable({hint:function(e){var t=e.clone().width(e.width());return $("<ol class='project-plan-activity-list ui-bizagi-wp-nolist'></ol>").append(t)},change:$.proxy(e.onChangePosition,e),disabled:".disabled",end:function(t){if(t.newIndex<e.fromIndexEnabledSortingActivities)t.preventDefault();else if(t.oldIndex!==t.newIndex){e.serviceOrderActivitiesByTransitions.movePositionActivity(e.params.plan.activities,t.oldIndex,t.newIndex);var a=$(".project-plan-activity-list li",e.content).eq(t.newIndex);if(!e.canChangeToParallelActivity(e.params.plan.activities,a)){e.params.plan.activities[t.newIndex].parallel=!1,t.newIndex,setTimeout(function(){$(".project-plan-activity-list li .wrapper-arrow-css i",e.content).eq(0).removeClass("bz-icon-arrow-right-outline").addClass("bz-icon-arrow-down-outline")},50)}}}}).data("kendoSortable")},updateTransitions:function(){var e=this,t=$.Deferred(),a={idPlan:e.params.plan.id,transitions:e.getActualTransitions()};return $.when(e.dataService.changeTransitions(a)).always(function(i,n,r){500===r.status&&e.plugins.notifier.showErrorMessage(bizagi.localization.getResource("workportal-project-plan-activities-sorterror"),"error"),e.params.plan.activities=e.orderActivitiesByTransitions(e.params.plan.activities,a.transitions),t.resolve()}),t.promise()},orderActivitiesByTransitions:function(e,t){return this.serviceOrderActivitiesByTransitions.getActivitiesByTransitions(e,t)},getActualTransitions:function(){var e=this,t=e.serviceOrderActivitiesByTransitions.getActualTransitionsByActivities(e.params.plan.activities);return t.forEach(function(t){t.id=void 0,t.idPlan=e.params.plan.id}),t},onChangePosition:function(){this.updateTransitions()},onCreateActivity:function(e){e.preventDefault();var t,a=this,i=$("#project-plan-activity-create",$(e.target)).val();if(t=a.params.plan.activities.length>0?a.params.plan.activities[a.params.plan.activities.length-1].userAssigned:bizagi.currentUser.idUser,""!==i.replace(/\s/g,"")){var n={progress:0,id:"",startDate:null,duration:null,userAssigned:t,allowEdition:!0,description:null,name:i,idPlan:a.params.plan.id,estimatedFinishDate:null,finishDate:null};if(a.params.plan.parent&&!bizagi.util.isEmpty(a.params.plan.parent.guidActivity)){var r={idPlan:a.params.plan.id,idActivity:a.params.plan.parent.guidActivity};$.when(a.dataService.getActivity(r)).done(function(e){n.allowEdition=e.allowEdition,a.createPlanActivity(n)})}else a.createPlanActivity(n)}e.target.reset(),e.preventDefault()},createPlanActivity:function(e){var t=this;$.when(t.dataService.createPlanActivity(e)).always(function(a,i,n){if(201===n.status){var r={idPlan:e.idPlan,idActivity:a.id};$.when(t.dataService.getActivity(r)).always(function(e){var i=$.extend(e,{id:a.id,items:[],numTotalItems:0,numResolvedItems:0,parallel:!1});t.renderActivities([i]),t.params.plan.activities.push(i);var n=$(".project-plan-activity-list",t.content);$("li:last .bz-icon-pencil-outline",n).trigger("click"),t.updateTransitions()})}else 500===a.status&&t.plugins.notifier.showErrorMessage(bizagi.localization.getResource("workportal-project-plan-activities-createarror"),"error")})},onClickChangeParallel:function(e){e.preventDefault();var t,a=$(".wrapper-arrow-css",e.currentTarget),i=a.closest("li"),n=i.data("id");this.canChangeToParallelActivity(this.params.plan.activities,i)&&($("i",a).hasClass("bz-icon-arrow-down-outline")?(t=!0,$("i",a).removeClass("bz-icon-arrow-down-outline").addClass("bz-icon-arrow-right-outline").prop("title",bizagi.localization.getResource("workportal-project-plan-activity-parallel"))):(t=!1,$("i",a).removeClass("bz-icon-arrow-right-outline").addClass("bz-icon-arrow-down-outline").prop("title",bizagi.localization.getResource("workportal-project-plan-activity-sequential"))),this.changeActivityProperties(n,{parallel:t}),this.updateTransitions())},canChangeToParallelActivity:function(e,t){var a=!0,i=this.getLastParallelActivityIsRunningOrClose(e);i&&(i===t.prev().data("id")&&(a=!1));return a},onClickEditActivity:function(e){var t,a=this,i=$(e.currentTarget),n=i.data("id"),r=a.params.plan.activities.filter(function(e){return e.id===n})[0],o="CLOSED_PLAN"!==a._statePlan&&"Completed"!==r.workItemState;if(a.params.showContextByMenuDashboard===a.CONTEXT_PLANACTIVITIES){t=n,a.idActivityEditing!==t&&(a.params.plan.idActivitySelected=t,i.closest("li").addClass("selected").siblings().removeClass("selected"),a.idActivityEditing=t,a.pub("notify",{type:"EDITACTIVITY",args:$.extend(a.params,{isEditableFormActivity:o,idActivityToShow:t})}),a.pub("notify",{type:"OPEN_RIGHT_SIDEBAR"}))}},changeActivityProperties:function(e,t){for(var a=0,i=this.params.plan.activities.length;a<i;a+=1)if(this.params.plan.activities[a].id===e){$.extend(this.params.plan.activities[a],t);break}},addEventHandlers:function(){$("#project-plan-activity-createform",this.content).on("submit",$.proxy(this.onCreateActivity,this)),$("#project-plan-activity-create",this.content).focus()},renderActivities:function(e){var t=this,a=$(".project-plan-activity-list",t.content),i=t.getTemplate("plan-activities-item");t.params.showContextByMenuDashboard===t.CONTEXT_PLANACTIVITIES&&a.addClass("enabled-actions");var n="PENDING"===t.params.plan.currentState?$("a#to-execute-plan",t.content):$("a#to-close-plan",t.content);e||t.params.plan.activities.length>0?n.show():n.hide();var r=e||t.params.plan.activities,o={statePlan:t._statePlan,statePendingPlan:t.PENDING_PLAN,stateExecutingPlan:t.EXECUTING_PLAN,context:t.params.showContextByMenuDashboard,activities:e||t.params.plan.activities,currentUserId:bizagi.currentUser.idUser};t._statePlan===t.EXECUTING_PLAN&&r.forEach(function(e){e.startDate?e.classEnabledActionActivities="disabled":e.classEnabledActionActivities=t.params.showContextByMenuDashboard===t.CONTEXT_PLANACTIVITIES?"enabled":"disabled",e.isRunning=t.runningActivity(e)}),o.activities=o.activities.map(function(e){return e.name=bizagi.util.decodeHtmlEntities(e.name),e.description=bizagi.util.decodeHtmlEntities(e.description),e});var s=i.render(o);a.append(s),t.fromIndexEnabledSortingActivities=t.params.plan.activities.filter(function(e){return"disabled"===e.classEnabledActionActivities}).length,t.loadAndShowImagesUsers(t.params.plan.activities)},runningActivity:function(e){return"Active"===e.workItemState||"Inactive"===e.workItemState},loadAndShowImagesUsers:function(e){var t=this;var a=function(e){for(var t={},a=[],i=e.length,n=0,r=0;r<i;r++){var o=e[r];1!==t[o]&&(t[o]=1,a[n++]=o)}return a}($.map(e,function(e){return e.userAssigned}).concat(bizagi.currentUser.userGuid)).join(",");t.getDataUsers(a).then(function(){t.renderUserProfilesAndImages()})},renderUserProfilesAndImages:function(){for(var e=this,t=0;t<e.userPictures.length;t+=1)$("div[data-iduser='"+e.userPictures[t].id+"']  span.ui-bizagi-user-initials").html(e.userPictures[t].name.getInitials()),e.userPictures[t].picture&&($("div[data-iduser='"+e.userPictures[t].id+"']  img").show(),$("div[data-iduser='"+e.userPictures[t].id+"']  span.ui-bizagi-user-initials").hide(),$("div[data-iduser='"+e.userPictures[t].id+"']  img").attr("src","data:image/png;base64,"+e.userPictures[t].picture))},getDataUsers:function(e){var t=this,a=$.Deferred(),i={usersGuids:e,width:50,height:50};return t.dataService.getUsersData(i).always(function(e){t.userPictures=function(e){for(var t=e.concat(),a=0;a<t.length;++a)for(var i=a+1;i<t.length;++i)t[a]===t[i]&&t.splice(i-=1,1);return t}(t.userPictures.concat(e)),a.resolve(e)}),a.promise()},onCancelActivityForm:function(){this.closeSidebar(),this.pub("notify",{type:"PLANSIDEBAR",args:this.params})},setContentWrapper:function(e){var t=$(".project-plan-content-wrapper",e);t.on("click",$.proxy(this.onCancelActivityForm,this)),$("#project-plan-activities-wrapper",e).on("click",function(e){e.stopPropagation()});var a=$(window).height()-156;t.css("height",a+"px")},onClickDeleteActivity:function(e){e.stopPropagation();var t=this,a=$(e.currentTarget).data("id"),i={idPlan:t.params.plan.id,id:a};$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-activity-delete-confirmation"),"","info")).done(function(){$.when(t.dataService.deleteActivityPlan(i)).done(function(){t.closeSidebar();for(var e=0,i=t.params.plan.activities.length;e<i;e+=1)t.params.plan.activities[e].id===a&&i>e+1&&e>0&&t.params.plan.activities[e+1].parallel&&t.params.plan.activities[e-1].parallel&&(t.params.plan.activities[e+1].parallel=!1,$(".project-plan-activity-list li[data-id='"+t.params.plan.activities[e].id+"']",t.content).next().find(".wrapper-arrow-css i").removeClass("bz-icon-arrow-right-outline").addClass("bz-icon-arrow-down-outline"));t.params.plan.activities=t.params.plan.activities.filter(function(e){return e.id!==a}),$.when(t.updateTransitions()).done(function(){t.renderWidgetByStatePlan(),t.pub("notify",{type:"PLANSIDEBAR",args:t.params})})})})},onClickWorkonItActivity:function(e){e.preventDefault();var t=$(e.target).closest("li").data("id"),a=this.params.plan.activities.filter(function(e){return e.id===t})[0];this.publish("executeAction",{action:bizagi.workportal.actions.action.BIZAGI_WORKPORTAL_ACTION_ROUTING,idCase:a.idCase,idWorkItem:a.idWorkItem})},onExecutePlan:function(e){e.preventDefault();var t=this;if(t.params.plan.activities.length>0){if(!$(e.target).closest("a").hasClass("disabled")){t.params.plan.currentState="EXECUTING",$(e.target).closest("a").addClass("disabled");var a={idPlan:t.params.plan.id};$.when(t.dataService.putExecutePlan(a)).done(function(){var a=$.extend(t.getCopyObjectPlan(),{startDate:t.getDateServer()});function i(e){t.params.planChild&&(t.params.planChild.currentState=t.params.plan.currentState),t.pub("notify",{type:"PLANACTIVITIES",args:$.extend(e,{refreshAllWidgets:!0})})}t.callUpdatePlan(a),$(e.target).closest("a").removeClass("disabled"),void 0===t.radNumber?$.when(t.dataService.getCaseByPlan({idPlan:t.params.plan.id})).done(function(e){t.params.idCase=e.id,i(t.params)}):i(t.params)})}}else t.plugins.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-action-execute-message-activities-required"),""))},onClosePlan:function(e){var t=this;e.preventDefault(),t.activitiesAreCompleted(t.params.plan.activities)?t.closePlan():$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-close-message-activities-finished"),"","info")).done(function(){t.closePlan()})},closePlan:function(){var e=this,t=$.extend(e.getCopyObjectPlan(),{currentState:"CLOSED"});$.when(e.callUpdatePlan(t)).done(function(){$.when(e.callClosePlan({idPlan:t.id})).done(function(){e.params.plan=t,e.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:e.params})}).fail(function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))})}).fail(function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-fail"),""))})},callUpdatePlan:function(e){var t=this;return $.when(t.dataService.updatePlan(e)).done(function(){$.extend(t.params.plan,e)})},callClosePlan:function(e){var t=this;return $.when(t.dataService.closePlan(e)).done(function(){$.extend(t.params.plan,e),t.plugins.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-close-success"),""))})},activitiesAreCompleted:function(e){return(e||[]).filter(function(e){return e.finishDate}).length===e.length},getLastParallelActivityIsRunningOrClose:function(e){var t=-1,a=e.filter(function(e){if(null!==e.startDate&&e.parallel)return t+=1,!0});return t>=0&&t+1!==e.length?a[a.length-1].id:null},refreshActivityRow:function(e,t){var a=$(".project-plan-activity-list li.selected");if(t.args.displayName&&$("p>span",a).text(t.args.displayName),t.args.assignee){var i=$(a).data("id"),n=this.params.plan.activities.filter(function(e){return e.id===i})[0];t.args.assignee!==bizagi.currentUser.idUser||"Active"!==n.workItemState&&"Inactive"!==n.workItemState?$(".item-workonit-button",a).hide():$(".item-workonit-button",a).show(),this.getDataUsers([t.args.assignee].join()).then(function(e){if($(".bz-wp-avatar span.ui-bizagi-user-initials",a).html(e[0].name.getInitials()),$("div.ui-bizagi-wp-project-plan-activity-infobox[data-iduser]",a).attr("data-iduser",t.args.assignee),e[0].picture){$(".bz-wp-avatar img",a).show(),$(".bz-wp-avatar  span.ui-bizagi-user-initials",a).hide(),$(".bz-wp-avatar img",a).attr("src","data:image/png;base64,"+e[0].picture)}})}},closeSidebar:function(){"yes"===(bizagi.services.preferences().getPreferences()?bizagi.services.preferences().getPreference("collapseSidebars"):"")&&"none"==$(".ui-bizagi-wp-project-panel-rowicon-right i.bz-icon-left-outline").css("display")&&$("li.clearfix.selected").length>0&&this.pub("notify",{type:"CLOSE_RIGHT_SIDEBAR"})},collapseSidebars:function(){"yes"===(bizagi.services.preferences().getPreferences()?bizagi.services.preferences().getPreference("collapseSidebars"):"")&&($("#ui-bizagi-wp-project-homeportal-main").addClass("ui-bizagi-wp-project-collapse-rightpanel"),$("#ui-bizagi-wp-project-homeportal-main").removeClass("ui-bizagi-wp-project-open-rightpanel"),$("#right-sidebar-wrapper").addClass("always-collpase"),$("#ui-bizagi-wp-project-homeportal-main").addClass("ui-bizagi-wp-project-collapse-leftpanel"),$("#ui-bizagi-wp-project-homeportal-main").removeClass("ui-bizagi-wp-project-open-leftpanel"),$("#left-sidebar-wrapper").addClass("always-collpase"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.activities",["workportalFacade","dataService","notifier","bizagi.workportal.services.behaviors.orderActivitiesByTransitions",bizagi.workportal.widgets.project.plan.activities],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.sidebar",{},{init:function(e,t,a,i){this._super(e,t,i),this.serviceloadDataPlan=a,this.params=i||{},i.supportNav=!1,this.loadTemplates({"project-plan-sidebar":bizagi.getTemplate("bizagi.workportal.desktop.widget.project.plan.sidebar").concat("#project-plan-sidebar")})},renderContent:function(){var e=this,t=e.getTemplate("project-plan-sidebar");return e.content=t.render({}),$.when(e.areTemplatedLoaded()).done(function(){var t={idPlan:e.params.plan.id};e.params.planChild&&e.params.planChild.id&&(t.idPlan=e.params.planChild.id),e.serviceloadDataPlan.loadData(t,e.getDateServer,e.params),e.serviceloadDataPlan.subscribe("loadedWithDataActivities",$.proxy(e.loadedWithDataActivities,e)),e.serviceloadDataPlan.subscribe("loadedWithDataFirstParent",$.proxy(e.loadedWithDataFirstParent,e))}),e.content},loadedWithDataActivities:function(){var e=this;e.pub("notify",{type:"LOADED_ACTIVITIES_PLAN",args:e.params}),e.pub("notify",{type:"UPDATE_INFO_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PROGRESS_PLAN",args:e.params}),e.pub("notify",{type:"LOAD_INFO_ACTIVITIES_PLAN",args:e.params})},loadedWithDataFirstParent:function(){this.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:this.params})},clean:function(){var e=this;e.serviceloadDataPlan&&(e.serviceloadDataPlan.unsubscribe("loadedWithDataActivities",$.proxy(e.loadedWithDataActivities,e)),e.serviceloadDataPlan.unsubscribe("loadedWithDataFirstParent",$.proxy(e.loadedWithDataFirstParent,e)))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.sidebar",["workportalFacade","dataService","bizagi.workportal.services.behaviors.loadDataPlan",bizagi.workportal.widgets.project.plan.sidebar],!0),bizagi.workportal.widgets.project.base.extend("bizagi.workportal.widgets.project.plan.action",{},{init:function(e,t,a,i,n,r,o){var s=this;s._super(e,t,o),s.PENDING_PLAN="PENDING",s.EXECUTING_PLAN="EXECUTING",s.CLOSED_PLAN="CLOSED",s.CONTEXT_ACTIVITYPLAN="ACTIVITYPLAN",s.CONTEXT_ACTIVITYPLANOVERVIEW="ACTIVITYPLANOVERVIEW",s.CONTEXT_PLANCREATE="PLANCREATE",s.CONTEXT_ACTIVITYPLANCREATE="ACTIVITYPLANCREATE",s.showActionsPlan=!1,s.projectDashboard=a,s.notifier=i,s.planTemplateCreate=n,s.planPopupEdit=r,s.loadTemplates({"plan-action-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.action").concat("#project-plan-action")})},renderContent:function(){var e=this,t=e.getTemplate("plan-action-main");return e.showActionsPlan=e.params.showContextByMenuDashboard!==e.CONTEXT_ACTIVITYPLAN&&e.params.showContextByMenuDashboard!==e.CONTEXT_ACTIVITYPLANOVERVIEW,e.plugins={},e.content=t.render({plan:e.params.plan.name,stateClosedPlan:e.CLOSED_PLAN,currentStatePlan:e.params.plan.currentState,showActionsPlan:e.showActionsPlan}),e.showActionsPlan&&(e.params.plan.contextualized=void 0===e.params.plan.contextualized||e.params.plan.contextualized),e.content},postRender:function(){var e=this,t=e.getContent();e.showActionsPlan&&(e.initilizeActionMenu(),$("a#to-close-plan",t).on("click",$.proxy(e.onClosePlan,e))),e.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(e.onNotifyLoadInfoSummaryPlan,e)),e.clearAlertsOnFocus(),e.planTemplateCreate.sub("planTemplateCreatedSuccess",function(){e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-success"),""))}),e.planTemplateCreate.sub("planTemplateCreatedFailed",function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-create-template-fail"),""))}),e.planPopupEdit.sub("planEditedSuccess",function(){e.setNamePlan(e.params.plan.name),e.pub("notify",{type:"UPDATE_INFO_PLAN"}),e.pub("notify",{type:"LOAD_INFO_SUMMARY_PLAN",args:e.params}),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-success"),""))}),e.planPopupEdit.sub("planEditedFailed",function(){e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-edit-fail"),""))}),e.sub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))},onNotifyExpandedRightSidebar:function(){this.showActionsPlan&&this.initilizeActionMenu()},onNotifyLoadInfoSummaryPlan:function(){this.setStatePlan(this.params.plan.currentState),this.setNamePlan(this.params.plan.name)},setStatePlan:function(e){if(e)switch(e.toUpperCase()){case"PENDING":$(".state-pending-plan",this.content).show().siblings().hide();break;case"EXECUTING":$(".state-executing-plan",this.content).show().siblings().hide();break;case"CLOSED":$(".state-closed-plan",this.content).show().siblings().hide()}},setNamePlan:function(e){$(".ui-bizagi-wp-project-plan-header .bz-wp-section",this.content).text(bizagi.util.decodeHtmlEntities(e))},onSelectMenu:function(e,t){if(0===$(e.currentTarget).find("i").length)switch($(t.item).data("item")){case"edit":this.onClickMenuOpenEdition();break;case"delete":this.onClickMenuDeletePlan();break;case"saveastmpl":this.onClickMenuSaveAsTemplate()}},onClickMenuOpenEdition:function(){var e=this.params.plan;this.planPopupEdit.showPopup(this.params,this.dataService,e)},onClickMenuSaveAsTemplate:function(){var e=this;e.planTemplateCreate.showPopupAddTemplatePlan(e.params,e.dataService,e.params.plan.contextualized,e.params.plan.id)},onClickMenuDeletePlan:function(){var e=this;$.when(bizagi.showConfirmationBox(bizagi.localization.getResource("workportal-project-plan-action-delete-confirmation"),"","info")).done(function(){var t={id:e.params.plan.id};$.when(e.callDeletePlan(t)).always(function(t){if(200===t.status||void 0===t.status){$.extend(e.params.plan,n),e.notifier.showSucessMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-success"),""));var a=e.pub("notify",{type:"NAVIGATOR_GETLEVEL"}),i=parseInt(a[0]),n=e.projectDashboard.getParamsByBackFromPlan(e.params,i,!0);e.pub("notify",{type:n.typeContext,args:$.extend(e.params,n.paramsNotify)})}else e.notifier.showErrorMessage(printf(bizagi.localization.getResource("workportal-project-plan-delete-fail"),""))})})},onSubmitFormPlan:function(e){e.preventDefault()},initilizeActionMenu:function(){$(".ui-bizagi-wp-project-plan-action-menu",this.content).menu({select:$.proxy(this.onSelectMenu,this)}).removeClass("ui-widget-content")},clearAlertsOnFocus:function(){$(".ui-bizagi-wp-project-container-validator-relative input, .ui-bizagi-wp-project-container-validator-relative textarea").focus(function(){$(this).parent().find(".k-invalid-msg").hide()}).focusout(function(){$(this).val().length<1&&$(this).parent().find(".k-invalid-msg").show()})},callDeletePlan:function(e){return $.when(this.dataService.deletePlan(e))},clean:function(){var e=this;e.planTemplateCreate.unsub("planTemplateCreatedSuccess"),e.planTemplateCreate.unsub("planTemplateCreatedFailed"),e.planPopupEdit.unsub("planEditedSuccess"),e.planPopupEdit.unsub("planEditedFailed"),e.unsub("EXPANDED_RIGHT_SIDEBAR",$.proxy(e.onNotifyExpandedRightSidebar,e))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.action",["workportalFacade","dataService","bizagi.workportal.services.behaviors.projectDashboard","notifier","bizagi.workportal.widgets.project.plan.template.create","bizagi.workportal.widgets.project.plan.edit",bizagi.workportal.widgets.project.plan.action],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.state",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-state-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.state").concat("#project-plan-state")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this,i=a.getTemplate("plan-state-main").render({});switch(a.params=$.extend(a.params,t.args),a.params.plan.currentState.toUpperCase()){case"PENDING":$(".state-pending",i).show().siblings().hide();break;case"EXECUTING":$(".state-executing",i).show().siblings().hide();break;case"CLOSED":$(".state-closed",i).show().siblings().hide()}a.content.empty().append(i)}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.state",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.state],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.progress",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-progress-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.progress").concat("#project-plan-progress")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PROGRESS_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this;a.params=$.extend(a.params,t.args);var i=a.getContent().empty(),n=a.calculateProgress(),r={};r.progress=n,r.progress<33?r.colorBar="Red":r.progress<66?r.colorBar="Yellow":r.colorBar="Green",a.getTemplate("plan-progress-main").render(r).appendTo(i);var o=$(".remaining-days .time-remaining",i),s=$(".remaining-days .days",i).width();o.css("padding-left",(s+7).toString()+"px")},calculateProgress:function(){var e=0,t=this.params.plan.activities.length,a=0;return 0!==t&&(this.params.plan.activities.forEach(function(t){"Completed"===t.workItemState&&e++}),a=Math.round(e/t*100)),a}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.progress",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.progress],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.time",{},{init:function(e,t,a){var i=this;i._super(e,t,a),i.PENDING_PLAN="PENDING",i.EXECUTING_PLAN="EXECUTING",i.CLOSED_PLAN="CLOSED",i.datePickerRegional=bizagi.localization.getResource("datePickerRegional"),i.loadTemplates({"plan-time-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.time").concat("#project-plan-time")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this;a.params=$.extend(a.params,t.args),a.params.plan&&(a.params.plan.dueDate?a.params.plan.currentState===a.PENDING_PLAN||a.params.plan.currentState===a.EXECUTING_PLAN?a.updateWidget(e,t):a.sub("LOADED_ACTIVITIES_PLAN",$.proxy(a.updateWidget,a)):a.getContent().empty())},planDatesToStamp:function(e){e.activities&&e.activities.map(function(e){e.estimatedFinishDate&&(e.estimatedFinishDate=new Date(e.estimatedFinishDate).getTime()),e.startDate&&(e.startDate=new Date(e.startDate).getTime()),e.finishDate&&(e.finishDate=new Date(e.finishDate).getTime())}),e.dueDate&&(e.dueDate=new Date(e.dueDate).getTime()),e.creationDate&&(e.creationDate=new Date(e.creationDate).getTime()),e.startDate&&(e.startDate=new Date(e.startDate).getTime()),e.closedDate&&(e.closedDate=new Date(e.closedDate).getTime()),e.finishDate&&(e.finishDate=new Date(e.finishDate).getTime())},updateWidget:function(e,t){var a=this;a.params=$.extend(a.params,t.args),a.planDatesToStamp(a.params.plan);var i=a.getContent().empty();a.params.plan.currentState===a.CLOSED_PLAN&&a.getClosedDatePlan(a.params.plan),$.when(a.getIntervalOnMinutes(a.params.plan)).done(function(e){var t=bizagi.util.dateFormatter.getRelativeTime(new Date(Date.now()-60*e.minutesToShowTime*1e3),null,!0),n=t.replace(/\d/g,""),r=a.getKeywordDifferenceDates(a.params.plan),o=bizagi.localization.getResource("workportal-project-plan-state-"+r);o=o.replace("%s",n);var s=t.replace(/\D/g,""),p=a.getSecondDate(a.params.plan),c=a.getWidthBar(a.params.plan,e),l=a.getColorBarByPercent(c),d={fromDate:a.getFormattedDate(new Date(a.getFirstDate(a.params.plan))),toDate:p?a.getFormattedDate(new Date(p)):null,valueOfTimeCalculated:s,messageDescripionDifference:o,percentBar:c,colorBar:l};a.getTemplate("plan-time-main").render(d).appendTo(i)})},getFirstDate:function(e){switch(e.currentState){case this.PENDING_PLAN:return e.dueDate?e.dueDate:e.creationDate;case this.EXECUTING_PLAN:case this.CLOSED_PLAN:return e.startDate}},getSecondDate:function(e){switch(e.currentState){case this.PENDING_PLAN:return null;case this.EXECUTING_PLAN:return e.dueDate;case this.CLOSED_PLAN:return e.closedDate}},getLastActivity:function(e){return JSON.parse(JSON.stringify(e)).sort(function(e,t){return e.finishDate<t.finishDate?1:-1})[0]},getClosedDatePlan:function(e){return e.closedDate=this.getLastActivity(e.activities).finishDate,e.closedDate},getDifferenceBetweenDates:function(e,t){var a=$.Deferred(),i={idUser:bizagi.currentUser.idUser,fromDate:e,toDate:t};return $.when(this.callGetEffectiveDuration(i)).done(function(e){a.resolve(e.minutes)}),a.promise()},getIntervalOnMinutes:function(e){var t=this,a=$.Deferred();switch(e.currentState){case t.PENDING_PLAN:e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done(function(i){$.when(t.getDifferenceBetweenDates(e.creationDate,Date.now())).done(function(e){a.resolve({minutesToShowTime:i,minutesCreateToNow:e})})}):e.dueDate<e.creationDate?$.when(t.getDifferenceBetweenDates(e.dueDate,e.creationDate)).done(function(i){$.when(t.getDifferenceBetweenDates(e.creationDate,Date.now())).done(function(e){a.resolve({minutesToShowTime:i+e,minutesCreateToNow:e})})}):e.dueDate>e.creationDate&&$.when(t.getDifferenceBetweenDates(e.creationDate,e.dueDate)).done(function(i){$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done(function(e){a.resolve({minutesToShowTime:i+e,minutesCreateToNow:e})})});break;case t.EXECUTING_PLAN:e.dueDate?e.dueDate>Date.now()?$.when(t.getDifferenceBetweenDates(Date.now(),e.dueDate)).done(function(i){$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done(function(e){a.resolve({minutesToShowTime:i,minutesStartToNow:e})})}):$.when(t.getDifferenceBetweenDates(e.dueDate,Date.now())).done(function(i){$.when(t.getDifferenceBetweenDates(e.startDate,e.dueDate)).done(function(e){a.resolve({minutesToShowTime:i,minutesStartToDueDate:e})})}):$.when(t.getDifferenceBetweenDates(e.startDate,Date.now())).done(function(e){a.resolve({minutesToShowTime:e})});break;case t.CLOSED_PLAN:$.when(t.getDifferenceBetweenDates(e.startDate,e.closedDate)).done(function(e){a.resolve({minutesToShowTime:e})})}return a.promise()},getKeywordDifferenceDates:function(e){switch(e.currentState){case this.PENDING_PLAN:return e.dueDate>Date.now()?"remaining":"exceeded";case this.EXECUTING_PLAN:return e.dueDate?e.dueDate>Date.now()?"remaining":"exceeded":"opened";case this.CLOSED_PLAN:return"executed"}},getRelativeTime:function(e){return bizagi.util.dateFormatter.getRelativeTime(e,null,!1)},getWidthBar:function(e,t){var a={};switch(e.currentState){case this.PENDING_PLAN:if(e.dueDate){if(e.dueDate<Date.now())return 0;var i=t.minutesCreateToNow+t.minutesToShowTime;return valuePercentInterval=t.minutesToShowTime,Math.ceil(100*valuePercentInterval/i)}return 0;case this.EXECUTING_PLAN:if(e.dueDate){if(e.dueDate>Date.now()){i=t.minutesStartToNow+t.minutesToShowTime;return valuePercentInterval=t.minutesToShowTime,Math.ceil(100*valuePercentInterval/i)}return 0}return 0;case this.CLOSED_PLAN:if(e.closedDate>Date.now()){var n=e.closedDate-e.startDate;return a=Date.now()-e.startDate,Math.ceil(100*a/n)}return 100}},getColorBarByPercent:function(e){return e<33?"Red":e<66?"Yellow":"Green"},callGetEffectiveDuration:function(e){var t=$.Deferred();return $.when(this.dataService.getEffectiveDuration(e)).done(function(e){t.resolve(e)}),t.promise()},getFormattedDate:function(e){return this.datePickerRegional.monthNames[e.getMonth()]+" "+bizagi.util.dateFormatter.formatDate(e,"dd hh:mm tt",bizagi.localization.getResource("datePickerRegional"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.time",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.time],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.parent",{},{init:function(e,t,a){this._super(e,t,a),this.loadTemplates({"plan-parent-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.parent").concat("#project-plan-parent")})},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_SUMMARY_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this,i=a.getContent().empty();a.params=$.extend(a.params,t.args),a.params.plan.parentWorkItem&&$.when(a.dataService.getPlanParent({idPlan:a.params.plan.id})).done(function(e){if(a.params.plan.parent=e,a.params.plan.parent){var t={idParent:a.params.plan.parent.radNumber,nameParent:a.params.plan.parent.displayName,idCase:a.params.plan.parent.idCase,idWorkflow:a.params.plan.parent.idWorkflow,idWorkItem:a.params.plan.parent.idWorkItem,idTask:a.params.plan.parent.idTask,processName:a.params.process?a.params.process:a.params.plan.parent.planName};if(bizagi.util.isEmpty(a.params.plan.parent.guidActivity))a.goToParentCase(i,t);else{var n={idPlan:a.params.plan.id,idActivity:a.params.plan.parent.guidActivity};$.when(a.dataService.getActivity(n)).done(function(e){a.params.plan.parent.allowEdition=e.allowEdition,a.goToParentCase(i,t)})}}}).fail(function(e){})},goToParentCase:function(e,t){e.empty(),this.getTemplate("plan-parent-main").render(t).appendTo(e),$("#go-to-parent-case",e).on("click",$.proxy(this.onClickGoToParentCase,this))},onClickGoToParentCase:function(e){e.preventDefault();this.routingExecute($(e.target).closest("#go-to-parent-case"))}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.parent",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.parent],!0),bizagi.workportal.widgets.widget.extend("bizagi.workportal.widgets.project.plan.users",{},{init:function(e,t,a){var i=this;i.usersMap={},i.plugins={},i.usersInformation=[],i.globalHandlersService=bizagi.injector.get("globalHandlersService"),i.usersAssignees=[],i._super(e,t,a),i.loadTemplates({"plan-users-main":bizagi.getTemplate("bizagi.workportal.desktop.project.plan.users").concat("#project-plan-users")}),i.auxNoRepeatTypesUser={},i.hashTypesUser={assigned:bizagi.localization.getResource("workportal-project-user-assigned"),owner:bizagi.localization.getResource("workportal-project-user-owner")}},renderContent:function(){return this.content=$("<div></div>"),this.content},postRender:function(){this.sub("LOAD_INFO_ACTIVITIES_PLAN",$.proxy(this.onNotifyLoadInfoSummaryPlan,this))},onNotifyLoadInfoSummaryPlan:function(e,t){var a=this,i=t.args,n=[],r=[],o=a.getContent().empty(),s=t.args.plan.idUserCreator,p=t.args.plan.idUserCreator;a.params=$.extend(a.params,t.args),r.push({idUser:p,userGuid:s,userType:["owner"]}),a.usersMap["-"+p+"-"]={picture:"",id:p,guid:s,name:"",userType:["owner"]},n.push(p),$.each(a.params.plan.activities,function(e,t){var i=t.userAssigned,o=t.userAssignedGuid;1==t.isRunning&&(i===p?-1===$.inArray("Assigned",r[0].userType)&&(r[0].userType.push("Assigned"),a.usersMap["-"+p+"-"].userType.push("Assigned")):(a.usersMap["-"+i+"-"]={picture:"",id:i,guid:o,name:"",userType:["Assigned"]},0===r.filter(function(e){return e.idUser==i}).length&&(r.push({idUser:i,guidUser:o,userType:["Assigned"]}),n.push(i))))}),a.activitiesUsers=r,a.params=i,a.getTemplate("plan-users-main").render({assignee:a.justAssignees(r),label:bizagi.localization.getResource("workportal-project-plan-assignee")}).appendTo(o),a.initilizeTooltip(),a.addEventHandlersModal(),$.when(a.callGetDataUsers(n)).then(function(){a.showCreatorInformation(p),a.renderUserProfilesAndImages()})},justAssignees:function(e){var t=[];return-1==["CLOSED","PENDING"].indexOf(this.params.plan.currentState)&&e.map(function(e){var a=-1!==e.userType.indexOf("owner"),i=-1!==e.userType.indexOf("Assigned");t.push(usersAdapter.createJsonUserInfo(e.idUser,"","","","","",i,a,[],[]))}),usersAdapter.justAssignees(t)},showCreatorInformation:function(e){var t=this.usersInformation.find(function(t){return t.id==e}),a=usersAdapter.createJsonUserInfo(t.id,t.name,t.username,t.picture?"data:image/png;base64,"+t.picture:void 0,t.email,t.name.getInitials(),!1,!0,[],[]);this.content.find(".ui-bizagi-wp-project-plan-users .ui-bizagi-wp-project-users-creator-info").userinformation(this,{user:a})},renderUserProfilesAndImages:function(){var e=this;$.each(e.usersMap,function(t,a){var i=$(".ui-bizagi-wp-userlist li[data-iduser="+a.id+"]",e.content);""!==a.picture?(i.find("img").prop("src",a.picture),$(".bz-wp-avatar-label",i).hide()):void 0!==a.name?($(".bz-wp-avatar-img",i).hide(),$(".bz-wp-avatar-label",i).html(a.name.getInitials())):console.log("obj.name is undefined")})},callGetDataUsers:function(e){var t,a=this,i=$.Deferred();return t={usersGuids:e.join(),width:50,height:50},$.when(a.dataService.getUsersData(t)).always(function(e){a.usersInformation=e;for(var t=0,n=e.length;t<n;t+=1)void 0===e[t].name?bizagi.log(e[t]+" Id Not Found",e,"error"):a.usersMap["-"+e[t].id+"-"]?(a.usersMap["-"+e[t].id+"-"].picture+=e[t].picture?"data:image/png;base64,"+e[t].picture:"",a.usersMap["-"+e[t].id+"-"].name=e[t].name||""):console.log("self.usersMap['-' + response[i].id + '-'] is undefined");a.getUsersAssignees(),i.resolve()}),i.promise()},activityRuning:function(e){return null!==e.startDate},getUsersAssignees:function(){for(var e=0;e<this.usersInformation.length;e++){var t=this.getUserAssignee(this.usersInformation[e]);!1!==t&&this.usersAssignees.push(t)}},getUserAssignee:function(e){var t=this,a=[];if($.each(t.params.plan.activities,function(i,n){n.userAssigned===e.id&&t.activityRuning(n)&&a.push({name:n.name})}),0==a.length)return!1;e.tasks=a;var i=t.activitiesUsers.find(function(t){return t.idUser==e.id});return e.types=void 0===i?[]:i.userType,usersAdapter.createJsonUserInfo(e.id,e.name,e.username,e.picture?"data:image/png;base64,"+e.picture:void 0,e.email,e.name.getInitials(),e.types.indexOf("Assigned")>-1,e.types.indexOf("owner")>-1,e.tasks,[])},initilizeTooltip:function(){var e=this;$(".ui-bizagi-wp-userlist > li",e.content).not(".moreUsers").on("mouseenter","",function(t){var a=$(t.target),i=a.closest("[data-iduser]").attr("data-iduser"),n=e.usersInformation.find(function(e){return e.id==i}),r=[];n.tasks&&n.tasks.map(function(e){r.push(e.name)});var o=e.activitiesUsers.find(function(e){return e.idUser==i});n.types=o.userType,n.owner=n.types.find(function(e){return"owner"==e}),n.isAssignee=n.types.find(function(e){return"Assigned"==e});var s=usersAdapter.createJsonUserInfo(n.id,n.name,n.username,n.picture?"data:image/png;base64,"+n.picture:void 0,n.email,n.name.getInitials(),n.isAssignee,n.owner,r,[]);a.parent().usertooltip(e,{target:a,user:s})})},addEventHandlersModal:function(){var e=this;$(".moreUsers").click(function(t){t.preventDefault(),t.stopPropagation();var a=e.usersAssignees||[];e.globalHandlersService.publish("showDialogWidget",{widgetName:bizagi.workportal.widgets.widget.BIZAGI_WORKPORTAL_WIDGET_USERS_MODAL,closeVisible:!0,data:a,maximize:!0,modalParameters:{title:bizagi.localization.getResource("workportal-project-users-title")+" ("+a.length+")",width:790,height:526,refreshInbox:!1}})})}}),bizagi.injector.register("bizagi.workportal.widgets.project.plan.users",["workportalFacade","dataService",bizagi.workportal.widgets.project.plan.users],!0);
//# sourceMappingURL=../../../../Maps/desktop/activityplanoverview.desktop.production.js.map
